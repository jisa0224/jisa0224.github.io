
<!doctype html>
<html lang="zh-TW" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://jisa0224.github.io/07%20%E9%9B%BB%E8%85%A6%E7%A7%91%E5%AD%B8/Linux/Linux%20kernel%20-%20Device%20%E5%8F%8A%20Device%20driver%20%28%E8%8D%89%E7%A8%BF%29/">
      
      
        <link rel="prev" href="../Linux%20kernel%20-%20Device%20%E5%8F%8A%20Device%20driver%20%28%E6%96%B0%29%20%28%E8%8D%89%E7%A8%BF%29/">
      
      
        <link rel="next" href="../Linux%20kernel%20-%20Storage%20stack%20%28%E8%8D%89%E7%A8%BF%29/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.12">
    
    
      
        <title>Linux kernel: Device 及 Device driver - Jisa's Notebook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.85bb2934.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/markdown-material-fix.css">
    
      <link rel="stylesheet" href="../../../css/disable-footer-nav.css">
    
      <link rel="stylesheet" href="../../../css/arithmatex.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linux-kernel-device-device-driver" class="md-skip">
          跳轉到
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="頁首">
    <a href="../../.." title="Jisa&#39;s Notebook" class="md-header__button md-logo" aria-label="Jisa's Notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jisa's Notebook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Linux kernel: Device 及 Device driver
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜尋" placeholder="搜尋" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="搜尋">
        
        <button type="reset" class="md-search__icon md-icon" title="清除" aria-label="清除" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="導覽列" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Jisa&#39;s Notebook" class="md-nav__button md-logo" aria-label="Jisa's Notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Jisa's Notebook
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        首頁
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          01 學習
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          01 學習
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../01%20%E5%AD%B8%E7%BF%92/C%20%E8%AA%9E%E8%A8%80%E7%B7%A8%E7%A8%8B/" class="md-nav__link">
        C 語言編程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../01%20%E5%AD%B8%E7%BF%92/%E6%9B%B8%E5%96%AE/" class="md-nav__link">
        書單
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          02 哲學
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          02 哲學
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../02%20%E5%93%B2%E5%AD%B8/%5B%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98%5D%20%E8%AA%B0%E6%98%AF%E6%88%91%EF%BC%9F%E6%84%8F%E8%AD%98%E7%9A%84%E5%93%B2%E5%AD%B8%E8%88%87%E7%A7%91%E5%AD%B8/" class="md-nav__link">
        [讀書筆記] 誰是我？意識的哲學與科學 (未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          03 數學
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          03 數學
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../03%20%E6%95%B8%E5%AD%B8/Bessel%27s%20Correction%20-%20%E7%B5%B1%E8%A8%88%E5%AD%B8%E8%A3%A1%E7%9A%84%20n-1/" class="md-nav__link">
        Bessel's Correction: 統計學裡的 n-1 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../03%20%E6%95%B8%E5%AD%B8/convolution/" class="md-nav__link">
        卷積 Convolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../03%20%E6%95%B8%E5%AD%B8/singular-value-and-eigenvalue/" class="md-nav__link">
        奇异值与特征值辨析 (轉載)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../03%20%E6%95%B8%E5%AD%B8/%E4%B8%80%E5%80%8B%E5%9C%96%E8%AB%96%E9%A1%8C%E7%9B%AE/" class="md-nav__link">
        一個圖論題目 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../03%20%E6%95%B8%E5%AD%B8/%E7%A9%8D%E5%88%86%E8%AE%8A%E6%8F%9B%28%E4%B8%80%29%EF%BC%9A%E5%82%85%E7%AB%8B%E8%91%89%E5%88%86%E6%9E%90/" class="md-nav__link">
        積分變換(一)：傅立葉分析 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../03%20%E6%95%B8%E5%AD%B8/%E7%B0%A1%E5%96%AE%E6%98%93%E6%87%82%E7%9A%84%E5%90%91%E9%87%8F%E5%BE%AE%E7%A9%8D%E5%88%86/" class="md-nav__link">
        簡單易懂的向量微積分 (未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          04 物理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          04 物理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../04%20%E7%89%A9%E7%90%86/%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E8%BD%89%E6%8F%9B%E7%9A%84%E7%89%A9%E7%90%86%E6%84%8F%E7%BE%A9/" class="md-nav__link">
        拉普拉斯轉換的物理意義 (未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          06 生物
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          06 生物
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../06%20%E7%94%9F%E7%89%A9/Body%20Transfer%20Illusion/" class="md-nav__link">
        Body Transfer Illusion (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../06%20%E7%94%9F%E7%89%A9/RNA%20sequencing%20%28RNA-Seq%29/" class="md-nav__link">
        RNA sequencing (RNA-Seq) (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../06%20%E7%94%9F%E7%89%A9/%5B%E6%9C%89%E8%B6%A3%E7%A0%94%E7%A9%B6%5D%20%E9%BB%8F%E8%8F%8C/" class="md-nav__link">
        [有趣研究] 黏菌 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../06%20%E7%94%9F%E7%89%A9/%5B%E7%9C%8B%E5%BD%B1%E7%89%87%5D%20%E4%BC%8A%E8%8E%89%E8%8E%8E%E7%99%BD%EF%BC%8E%E7%BE%85%E8%8A%99%E6%89%98%E6%96%AF%20%28Elizabeth%20Loftus%29%EF%BC%9A%E8%99%9B%E6%A7%8B%E7%9A%84%E8%A8%98%E6%86%B6%20-%20TED%20Talk/" class="md-nav__link">
        [看影片] 伊莉莎白．羅芙托斯 (Elizabeth Loftus)：虛構的記憶 - TED Talk (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../06%20%E7%94%9F%E7%89%A9/%5B%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98%5D%20%E5%A4%A7%E8%85%A6%E7%B0%A1%E5%8F%B2%EF%BC%9A%E7%94%9F%E7%89%A9%E7%B6%93%E9%81%8E%E5%9B%9B%E5%8D%81%E5%84%84%E5%B9%B4%E7%9A%84%E6%BC%94%E5%8C%96%EF%BC%8C%E5%A4%A7%E8%85%A6%E6%98%AF%E5%90%A6%E5%B7%B2%E7%B6%93%E8%B6%85%E8%84%AB%E8%87%AA%E7%A7%81%E5%9F%BA%E5%9B%A0%E7%9A%84%E6%8E%8C%E6%8E%A7%EF%BC%9F/" class="md-nav__link">
        [讀書筆記] 大腦簡史：生物經過四十億年的演化，大腦是否已經超脫自私基因的掌控？ (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../06%20%E7%94%9F%E7%89%A9/%E6%BB%B2%E9%80%8F%E6%80%A7%EF%BC%88Osmolarity%EF%BC%89vs.%20%E5%BC%B5%E6%80%A7%EF%BC%88Tonicity%EF%BC%89%EF%BC%8C%E5%8F%8A%E6%BB%B2%E9%80%8F%E6%BF%83%E5%BA%A6%EF%BC%88Osmolarity%EF%BC%89/" class="md-nav__link">
        滲透性（Osmolarity）vs. 張性（Tonicity），及滲透濃度（Osmolarity）
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          07 電腦科學
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          07 電腦科學
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_7_1">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../C%20%E8%AA%9E%E8%A8%80%20printf%20%E5%92%8C%20write%20%E5%8E%9F%E7%90%86/" class="md-nav__link">
        C 語言 printf 和 write 原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20Job%20Control%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux Job Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20TTY%20and%20VT%20subsystem%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux TTY and VT subsystem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20driver%20%E8%BC%89%E5%85%A5%E6%B5%81%E7%A8%8B%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux driver 載入流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20Device%20%E5%8F%8A%20Device%20driver%20%28%E6%96%B0%29%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: Device 及 Device driver
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Linux kernel: Device 及 Device driver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Linux kernel: Device 及 Device driver
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#device" class="md-nav__link">
    Device
  </a>
  
    <nav class="md-nav" aria-label="Device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-number" class="md-nav__link">
    設備號 (device number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    註冊裝置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    更高級的抽象裝置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-driver" class="md-nav__link">
    Device driver
  </a>
  
    <nav class="md-nav" aria-label="Device driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-driver_1" class="md-nav__link">
    註冊 device driver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-driver_2" class="md-nav__link">
    載入 device driver
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#character-device" class="md-nav__link">
    Character device
  </a>
  
    <nav class="md-nav" aria-label="Character device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#character-device_1" class="md-nav__link">
    註冊 character device
  </a>
  
    <nav class="md-nav" aria-label="註冊 character device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-character-device-table" class="md-nav__link">
    System character device table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#driver" class="md-nav__link">
    註冊 driver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    註冊裝置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#character-device_2" class="md-nav__link">
    註冊 character device
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#block-device" class="md-nav__link">
    Block device
  </a>
  
    <nav class="md-nav" aria-label="Block device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#driver_1" class="md-nav__link">
    註冊 driver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-device_1" class="md-nav__link">
    註冊裝置和註冊 block device
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-file" class="md-nav__link">
    存取 device file
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20Storage%20stack%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: Storage stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20character%20devices%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: character devices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20console%20%E5%88%9D%E5%A7%8B%E5%8C%96%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: console 初始化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20framebuffer%20device%20%E5%8F%8A%20framebuffer%20console%20%E5%88%9D%E5%A7%8B%E5%8C%96%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: framebuffer device 及 framebuffer console 初始化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20kernel%20logging%2C%20kernel%20ring%20buffer%2C%20printk%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: kernel logging, kernel ring buffer, printk
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20system%20call%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: system call
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20-%20virtual%20file%20system%20%28VFS%29%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel: virtual file system (VFS)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20macro%20-%20container_of%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel macro: container_of
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20module%20%E8%BC%89%E5%85%A5%E6%B5%81%E7%A8%8B%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel module 載入流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20kernel%20%E5%95%9F%E5%8B%95%E6%B5%81%E7%A8%8B%20%28%E5%BE%9E%20architecture-dependent%20kernel%20entry%20%E5%88%B0%20init%29%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux kernel 啟動流程 (從 architecture dependent kernel entry 到 init) (草稿)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20%E5%87%BD%E5%BC%8F%E5%BA%AB%E7%9A%84%E5%BB%BA%E7%AB%8B%E3%80%81%E4%BD%BF%E7%94%A8%E8%88%87%E6%90%9C%E5%B0%8B%E8%B7%AF%E5%BE%91%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux 函式庫的建立、使用與搜尋路徑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20%E5%89%AA%E8%B2%BC%E7%B0%BF%E5%8E%9F%E7%90%86/" class="md-nav__link">
        Linux 剪貼簿
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20%E5%95%9F%E5%8B%95%E6%B5%81%E7%A8%8B%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux 啟動流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20%E6%AA%94%E6%A1%88%E6%AC%8A%E9%99%90%E8%88%87%E5%B1%AC%E6%80%A7%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux 檔案權限與屬性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux%20%E9%97%9C%E9%96%89%E6%B5%81%E7%A8%8B%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux 關閉流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../X%20Window%20System%20-%20Display%20Name%20%E8%88%87%20X%20Server-Client%20%E7%9A%84%E5%95%9F%E5%8B%95/" class="md-nav__link">
        X Window System: Display Name 與 X Server/Client 的啟動
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../X%20Window%20System%20-%20X%20Client%20%E5%A6%82%E4%BD%95%E8%88%87%20X%20Server%20%E9%80%9A%E8%A8%8A/" class="md-nav__link">
        X Window System: X Client 如何與 X Server 通訊
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../XTerm%20%E7%9A%84%20Alternate%20Screen%20Buffer/" class="md-nav__link">
        XTerm 的 Alternate Screen Buffer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../systemd-logind%20%E5%8E%9F%E7%90%86/" class="md-nav__link">
        systemd-logind 原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
      
      
      
        <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Web/%E7%B6%B2%E9%A0%81%E5%9C%96%E7%A4%BA/" class="md-nav__link">
        網頁圖示 (未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
      
      
      
        <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
          Windows
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_3">
          <span class="md-nav__icon md-icon"></span>
          Windows
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Windows/Windows%20%E9%9A%B1%E8%97%8F%E7%A3%81%E5%8D%80/" class="md-nav__link">
        Windows 隱藏磁區 (草稿)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
      
      
      
        <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
          作業系統
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_4">
          <span class="md-nav__icon md-icon"></span>
          作業系統
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/MIT%206.S081%202021%20-%20xv6%20Labs%20%E7%92%B0%E5%A2%83%E9%85%8D%E7%BD%AE%20%28%E6%96%B0%29%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        MIT 6.S081 2021: xv6 Labs 環境配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/MIT%206.S081%202021%20-%20xv6%20Labs%20%E7%92%B0%E5%A2%83%E9%85%8D%E7%BD%AE%20%28%E8%88%8A%29/" class="md-nav__link">
        xv6 (RISC-V 版本)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/Qemu%20RISC-V%20VirtIO%20board%20%E9%96%8B%E6%A9%9F%E6%B5%81%E7%A8%8B/" class="md-nav__link">
        Qemu RISC-V VirtIO board 開機流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/RISC-V%20SBI%20%E4%BB%8B%E7%B4%B9/" class="md-nav__link">
        RISC-V SBI 介紹
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/User-Mode%20Linux/" class="md-nav__link">
        User-Mode Linux
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/%E4%BD%BF%E7%94%A8%20Qemu%20%E5%92%8C%20Visual%20Studio%20Code%20%E9%99%A4%E9%8C%AF%20Linux%20kernel%20%28RISC-V%29/" class="md-nav__link">
        使用 Qemu 和 Visual Studio Code 除錯 Linux kernel (RISC-V)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1/%E4%BD%BF%E7%94%A8%20Qemu%20%E5%92%8C%20Visual%20Studio%20Code%20%E9%99%A4%E9%8C%AF%20Linux%20kernel%20%28x86_64%29/" class="md-nav__link">
        使用 Qemu 和 Visual Studio Code 除錯 Linux kernel (x86_64)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5" >
      
      
      
        <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
          未分類
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_5">
          <span class="md-nav__icon md-icon"></span>
          未分類
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/Continuation%20-%20%E4%BD%BF%E7%94%A8%20Scheme%20%E7%9A%84%20callcc%20%E5%AF%A6%E7%8F%BE%20generator/" class="md-nav__link">
        Continuation: 使用 Scheme 的 call/cc 實現 generator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-01-problem-2.27/" class="md-nav__link">
        【CS:APP 筆記】Problem 2.27 檢查無號整數相加是否溢位
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-02-c-details-of-declaring-pointers/" class="md-nav__link">
        【CS:APP 筆記】C 語言中宣告指標的小細節
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-03-x86_64-jmp-notes/" class="md-nav__link">
        【CS:APP 筆記】x86_64 中的 JMP 指令整理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-04-x86_64-flags/" class="md-nav__link">
        【CS:APP 筆記】x86_64 旗標暫存器與大小判斷
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-05-rounding/" class="md-nav__link">
        【CS:APP 筆記】數值修約(rounding)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-06-why-callee-saved-registers/" class="md-nav__link">
        【CS:APP 筆記】為什麼要有 callee-saved 暫存器？(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-07-array-vs-pointer/" class="md-nav__link">
        【CS:APP 筆記】陣列與指標間的一些區別與可變大小陣列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-08-stack-and-uninitialized-local-variables/" class="md-nav__link">
        【CS:APP 筆記】Stack 與未初始化的區域變數
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-09-x86_64-byte-order-of-push-and-pop/" class="md-nav__link">
        【CS:APP 筆記】x86_64 PUSH 與 POP 的 byte order
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/csapp-notes-10-p.259/" class="md-nav__link">
        【CS:APP 筆記】P.259 多維陣列取值的組合語言另解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/io-models-blocking-nonblocking-synchronous-asynchronous/" class="md-nav__link">
        I/O 模型：阻塞、非阻塞、同步、異步
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/%E4%BA%8B%E4%BB%B6%E8%BF%B4%E5%9C%88%E3%80%81IO%20%E6%A9%9F%E5%88%B6%E8%88%87%20CPU%20idle/" class="md-nav__link">
        事件迴圈、I/O 機制與 CPU idle
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%9C%AA%E5%88%86%E9%A1%9E/%E9%9B%BB%E8%B7%AF%E3%80%81%E9%82%8F%E8%BC%AF%E9%96%98%E3%80%81%E8%A8%88%E7%AE%97%E6%A9%9F%E5%92%8C%E9%9B%BB%E8%85%A6%E7%9A%84%E5%85%B6%E5%AE%83%E5%AF%A6%E7%8F%BE/" class="md-nav__link">
        電路、邏輯閘、計算機和電腦的其它實現
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_6" >
      
      
      
        <label class="md-nav__link" for="__nav_7_6" id="__nav_7_6_label" tabindex="0">
          機器學習
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_6">
          <span class="md-nav__icon md-icon"></span>
          機器學習
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92/%5B%E8%AE%80%E8%AB%96%E6%96%87%5D%20Large-Scale%20Study%20of%20Curiosity-Driven%20Learning/" class="md-nav__link">
        [讀論文] Large-Scale Study of Curiosity-Driven Learning
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7_7" id="__nav_7_7_label" tabindex="0">
          程式設計
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_7">
          <span class="md-nav__icon md-icon"></span>
          程式設計
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/how-to-read-code-efficiently/" class="md-nav__link">
        如何高效阅读代码？ (轉載)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/unicode-you-dont-know/" class="md-nav__link">
        其实你并不懂 Unicode (轉載)
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_7_3" >
      
      
      
        <label class="md-nav__link" for="__nav_7_7_3" id="__nav_7_7_3_label" tabindex="0">
          資料結構與演算法
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_7_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_7_3">
          <span class="md-nav__icon md-icon"></span>
          資料結構與演算法
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%E8%88%87%E6%BC%94%E7%AE%97%E6%B3%95/%5B%E6%9C%89%E8%B6%A3%E7%A0%94%E7%A9%B6%5D%20%E5%BE%9E%E5%BD%B1%E5%83%8F%E7%9A%84%E6%A5%B5%E8%BC%95%E5%BE%AE%E9%9C%87%E5%8B%95%E9%82%84%E5%8E%9F%E5%87%BA%E7%8F%BE%E5%A0%B4%E8%81%B2%E9%9F%B3/" class="md-nav__link">
        [有趣研究] 從影像的極輕微震動還原出現場聲音 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%E8%88%87%E6%BC%94%E7%AE%97%E6%B3%95/%5B%E6%BC%94%E7%AE%97%E6%B3%95%E7%AD%86%E8%A8%98%5D%20%E6%9C%80%E5%A4%A7%E5%AD%90%E6%95%B8%E5%88%97%E5%95%8F%E9%A1%8C%20Maximum%20Subarray%20Problem/" class="md-nav__link">
        [演算法筆記] 最大子數列問題 Maximum Subarray Problem (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%E8%88%87%E6%BC%94%E7%AE%97%E6%B3%95/algorithm-notes-optimal-substructure/" class="md-nav__link">
        [演算法筆記] 最優子結構 Optimal Substructure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%E8%88%87%E6%BC%94%E7%AE%97%E6%B3%95/fun-research-computational-periscopy-with-an-ordinary-digital-camera/" class="md-nav__link">
        [有趣研究] 只要算法够厉害，白墙能当镜子用：我初中物理都白学了 | Nature新论文 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%E8%88%87%E6%BC%94%E7%AE%97%E6%B3%95/%E7%94%9F%E6%88%90%E4%B8%8D%E9%87%8D%E8%A4%87%E9%9A%A8%E6%A9%9F%E6%95%B8%EF%BC%9AFisher-Yates%20shuffle/" class="md-nav__link">
        生成不重複隨機數：Fisher-Yates shuffle
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B%E8%88%87%E6%BC%94%E7%AE%97%E6%B3%95/%E7%9D%A1%E7%9C%A0%E6%8E%92%E5%BA%8F%20Sleep%20Sort/" class="md-nav__link">
        睡眠排序 Sleep Sort
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_8" >
      
      
      
        <label class="md-nav__link" for="__nav_7_8" id="__nav_7_8_label" tabindex="0">
          計算數學
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_8">
          <span class="md-nav__icon md-icon"></span>
          計算數學
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%A8%88%E7%AE%97%E6%95%B8%E5%AD%B8/%E8%87%AA%E5%8B%95%E5%BE%AE%E5%88%86%20Automatic%20Differentiation/" class="md-nav__link">
        自動微分 Automatic Differentiation (未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          08 電腦實務
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          08 電腦實務
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
      
      
      
        <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
          01 我的設定
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          01 我的設定
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Arch%20Linux%20%28%E8%99%9B%E6%93%AC%E6%A9%9F%29/" class="md-nav__link">
        Arch Linux (虛擬機)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Arch%20Linux%2001%20%E7%B3%BB%E7%B5%B1%E5%AE%89%E8%A3%9D/" class="md-nav__link">
        Arch Linux 01 系統安裝
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Arch%20Linux%2002%20%E8%A8%AD%E5%AE%9A%E8%88%87%E5%B7%B2%E7%9F%A5%E5%95%8F%E9%A1%8C/" class="md-nav__link">
        Arch Linux 02 設定與已知問題
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Arch%20Linux%2003%20%E8%BB%9F%E9%AB%94%E5%8C%85%E6%B8%85%E5%96%AE/" class="md-nav__link">
        Arch Linux 03 軟體包清單
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Arch%20Linux%2004%20%E9%9B%9C%E9%A0%85/" class="md-nav__link">
        Arch Linux 04 雜項
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Arch%20Linux%2005%20%E4%BD%BF%E7%94%A8%20Wayland%20%E5%92%8C%20PipeWire%20%E5%8F%96%E4%BB%A3%20X%20Window%20System%20%E5%92%8C%20Pulseaudio%20%E8%88%87%20JACK/" class="md-nav__link">
        Arch Linux 05 使用 Wayland 和 PipeWire 取代 X Window System 和 Pulseaudio 與 JACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/VMware%20Workstation/" class="md-nav__link">
        VMware Workstation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Visual%20Studio%20Code/" class="md-nav__link">
        Visual Studio Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Windows%2010%20%28%E8%99%9B%E6%93%AC%E6%A9%9F%29/" class="md-nav__link">
        Windows 10 (虛擬機)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Windows%2010/" class="md-nav__link">
        Windows 10
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Windows%2011%20%28%E8%99%9B%E6%93%AC%E6%A9%9F%29/" class="md-nav__link">
        Windows 11 (虛擬機)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Windows%2011%20%E5%B7%A5%E5%85%B7%E5%88%97%E3%80%81%E9%96%8B%E5%A7%8B%E5%8A%9F%E8%83%BD%E8%A1%A8%E9%82%84%E5%8E%9F%E7%A8%8B%E5%BC%8F%E8%A9%95%E6%B8%AC/" class="md-nav__link">
        Windows 11 工具列、開始功能表還原程式評測
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Windows%2011%20%E7%95%8C%E9%9D%A2%E8%AA%BF%E6%A0%A1/" class="md-nav__link">
        Windows 11 界面調校
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/01%20%E6%88%91%E7%9A%84%E8%A8%AD%E5%AE%9A/Windows%20Subsystem%20for%20Linux%20%28WSL%29/" class="md-nav__link">
        Windows Subsystem for Linux (WSL)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
          02 Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          02 Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Bash%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        Bash 使用技巧 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Bash%20%E5%9C%A8%20Emacs%20%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%BF%AB%E9%80%9F%E9%8D%B5%E5%92%8C%E5%85%B6%E8%A1%9D%E7%AA%81%E5%88%97%E8%A1%A8/" class="md-nav__link">
        Bash 在 Emacs 模式下的快速鍵和其衝突列表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Bash%20%E5%A6%82%E4%BD%95%E5%B1%95%E9%96%8B%20asterisk%20%E8%87%AA%E5%8B%95%E8%A3%9C%E5%85%A8/" class="md-nav__link">
        Bash 如何展開 * 自動補全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Bash%20%E5%A6%82%E4%BD%95%E8%BC%B8%E5%85%A5%E5%90%8C%E8%B3%87%E6%96%99%E5%A4%BE%E4%B8%8B%E7%9A%84%E6%AA%94%E5%90%8D%E4%BD%86%E4%B8%8D%E9%87%8D%E8%A4%87%E8%BC%B8%E5%85%A5%E8%B7%AF%E5%BE%91/" class="md-nav__link">
        Bash 如何輸入同資料夾下的檔名但不重複輸入路徑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/GCC%20%E9%80%A3%E7%B5%90%E6%99%82%E7%9A%84%E5%8F%83%E6%95%B8%E6%9C%89%E5%85%88%E5%BE%8C%E9%A0%86%E5%BA%8F/" class="md-nav__link">
        GCC 連結時的參數有先後順序
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/GNU%20Binutils%20-%20a%20collection%20of%20binary%20tools%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        GNU Binutils: a collection of binary tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/GNU%20Coreutils%20-%20the%20basic%20file%2C%20shell%20and%20text%20manipulation%20utilities%20of%20the%20GNU%20operating%20system/" class="md-nav__link">
        GNU Coreutils: the basic file, shell and text manipulation utilities of the GNU operating system
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20Kernel%20%E5%BB%BA%E7%BD%AE%20-%20%E8%A8%AD%E5%AE%9A%E7%89%88%E6%9C%AC%E8%99%9F/" class="md-nav__link">
        Linux Kernel 建置: 設定版本號
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20cp%20%E8%88%87%20install%20%E6%8C%87%E4%BB%A4%E6%AF%94%E8%BC%83/" class="md-nav__link">
        Linux cp 與 install 指令比較
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E5%9B%A0%E7%82%BA%20Intel%20IBT%20%E5%B0%8E%E8%87%B4%E7%84%A1%E6%B3%95%E8%BC%89%E5%85%A5%20module%20%E5%95%8F%E9%A1%8C/" class="md-nav__link">
        Linux 因為 Intel IBT 導致無法載入 module 問題
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E5%9F%B7%E8%A1%8C%E7%A8%8B%E5%BC%8F%E6%99%82%E5%87%BA%E7%8F%BE%20No%20such%20file%20or%20directory%20%E9%8C%AF%E8%AA%A4/" class="md-nav__link">
        Linux 執行程式時出現 No such file or directory 錯誤
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E5%BC%B7%E5%88%B6%E6%9B%B4%E6%96%B0%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E6%B8%85%E5%96%AE%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Linux 強制更新應用程式清單
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E5%BE%9E%20kernel%20parameter%20%E7%A6%81%E7%94%A8%E7%89%B9%E5%AE%9A%20module/" class="md-nav__link">
        Linux 從 kernel parameter 禁用特定 module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E6%AF%94%E8%BC%83%E5%92%8C%E5%90%8C%E6%AD%A5%E5%85%A9%E5%80%8B%E8%B3%87%E6%96%99%E5%A4%BE%E7%9A%84%E6%93%81%E6%9C%89%E8%80%85%E5%92%8C%E6%AC%8A%E9%99%90/" class="md-nav__link">
        Linux 比較和同步兩個資料夾的所有權和權限
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E7%95%B6%E6%A9%9F%E8%99%95%E7%90%86%E8%88%87%20Magic%20SysRq%20Key/" class="md-nav__link">
        Linux 當機處理與 Magic SysRq Key
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E9%9A%B1%E8%97%8F%20Windows%20%E7%B3%BB%E7%B5%B1%E6%AA%94%E6%A1%88/" class="md-nav__link">
        Linux 隱藏 Windows 系統檔案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Linux%20%E9%A1%AF%E7%A4%BA%E6%8E%9B%E8%BC%89%E9%BB%9E%E8%B3%87%E8%A8%8A/" class="md-nav__link">
        Linux 顯示已掛載的裝置資訊
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Readline%20%28%E5%8F%8A%E5%85%B6%E4%BD%BF%E7%94%A8%E8%80%85%20Bash%29%20%E6%8C%89%E9%8D%B5%E9%80%9F%E6%9F%A5%E8%A1%A8%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        Readline (及其使用者 Bash) 按鍵速查表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Systemd%20%E9%80%9F%E6%9F%A5%E8%A1%A8/" class="md-nav__link">
        Systemd 速查表
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Vim%20%E4%BB%A5%20root%20%E6%AC%8A%E9%99%90%E9%96%8B%E5%95%9F%E3%80%81%E9%96%8B%E5%95%9F%E5%BE%8C%E4%BB%A5%20root%20%E6%AC%8A%E9%99%90%E5%84%B2%E5%AD%98%E4%BB%A5%E5%8F%8A%E5%BC%B7%E5%88%B6%E5%AF%AB%E5%85%A5%E7%9A%84%E7%96%91%E5%95%8F/" class="md-nav__link">
        Vim 以 root 權限開啟、開啟後以 root 權限儲存以及強制寫入(:w!)的疑問
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Vim%20%E5%9F%B7%E8%A1%8C%20shell%20%E6%8C%87%E4%BB%A4%E5%92%8C%E8%BC%B8%E5%87%BA%E5%85%A5%E9%87%8D%E5%AE%9A%E5%90%91/" class="md-nav__link">
        Vim 執行 shell 指令和輸出入重定向
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/Virtualbox%20-%20%E6%8E%9B%E8%BC%89%20VirtualBox%20VDI%20%E7%A3%81%E7%A2%9F%E6%98%A0%E5%83%8F%E6%AA%94/" class="md-nav__link">
        Virtualbox: 掛載 VirtualBox VDI 磁碟映像檔
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/cp%20-%20omitting%20directory%20%E9%8C%AF%E8%AA%A4/" class="md-nav__link">
        cp: omitting directory 錯誤
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/cp%20%E8%A4%87%E8%A3%BD%E5%8C%85%E5%90%AB%E9%9A%B1%E8%97%8F%E6%AA%94%E5%9C%A8%E5%85%A7%E7%9A%84%E6%89%80%E6%9C%89%E6%AA%94%E6%A1%88/" class="md-nav__link">
        cp 複製包含隱藏檔在內的所有檔案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/dd%20-%20%E8%A3%BD%E4%BD%9C%E5%8F%AF%E9%96%8B%E6%A9%9F%20USB/" class="md-nav__link">
        dd: 製作可開機 USB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/ps%20%E5%8F%83%E6%95%B8%E6%95%B4%E7%90%86/" class="md-nav__link">
        ps 參數整理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/sudo%20-%20%E7%82%BA%E4%BB%80%E9%BA%BC%E4%BD%BF%E7%94%A8%20sudo%20%E4%BB%8D%E5%BE%97%E5%88%B0%20Permission%20denied%EF%BC%9F/" class="md-nav__link">
        sudo: 為什麼使用 sudo 仍得到 Permission denied？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/util-linux%20-%20a%20random%20collection%20of%20Linux%20utilities%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        util-linux: a random collection of Linux utilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/02%20Linux/%E4%BF%AE%E5%BE%A9%E5%BC%B7%E5%88%B6%E9%97%9C%E6%A9%9F%E5%B0%8E%E8%87%B4%E7%84%A1%E6%B3%95%E6%8E%9B%E8%BC%89%20NTFS%20%E5%88%86%E5%89%B2%E5%8D%80/" class="md-nav__link">
        修復強制關機導致無法掛載 NTFS 分割區
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
      
      
      
        <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
          03 Windows
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          03 Windows
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/03%20Windows/Windows%2010%20%E6%9C%AC%E6%A9%9F%E9%9A%B1%E8%97%8F%E9%A0%90%E8%A8%AD%E8%B3%87%E6%96%99%E5%A4%BE/" class="md-nav__link">
        Windows 10 本機隱藏預設資料夾 (TBD)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/03%20Windows/Windows%20%E5%81%9C%E6%AD%A2%E7%94%A2%E7%94%9F%20Zone.Identifier%20%E6%AA%94%E6%A1%88/" class="md-nav__link">
        Windows 停止產生 Zone.Identifier 檔案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/03%20Windows/Windows%20%E5%8F%B3%E9%8D%B5%E9%81%B8%E5%96%AE%E5%8A%A0%E5%85%A5%E5%9C%A8%E9%80%99%E8%A3%A1%E9%96%8B%E5%95%9F%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E5%AD%97%E5%85%83/" class="md-nav__link">
        Windows 右鍵選單加入「在這裡開啟命令提示字元」 (TBD)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
      
      
      
        <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
          04 應用程式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_4">
          <span class="md-nav__icon md-icon"></span>
          04 應用程式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Adobe%20Flash%20Player%20%E7%B5%90%E6%9D%9F%E6%9C%8D%E5%8B%99%E5%BE%8C%E7%B9%BC%E7%BA%8C%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95/" class="md-nav__link">
        Adobe Flash Player 結束服務後繼續使用的方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Android%20%E5%81%9C%E7%94%A8%E7%84%A1%E6%B3%95%E5%81%9C%E7%94%A8%E7%9A%84%E5%85%A7%E5%BB%BA%20APP/" class="md-nav__link">
        Android 停用無法停用的內建 APP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Android%20%E7%99%BB%E5%85%A5%20Gmail%20%E4%BD%86%E4%B8%8D%E8%A6%81%E5%8A%A0%E5%85%A5%20Google%20%E5%B8%B3%E8%99%9F%E5%88%B0%E6%89%8B%E6%A9%9F/" class="md-nav__link">
        Android 登入 Gmail 但不要加入 Google 帳號到手機
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Firefox%20AV1%20glitch%20%E5%95%8F%E9%A1%8C/" class="md-nav__link">
        Firefox AV1 glitch 問題
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Firefox%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        Firefox 使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Git%20-%20Rebase%20a%20Merge%20Commit/" class="md-nav__link">
        Git: Rebase a Merge Commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Git%20%E6%AA%94%E6%A1%88%E7%A7%BB%E5%8B%95%E5%92%8C%E6%9B%B4%E5%90%8D/" class="md-nav__link">
        Git 檔案移動和更名
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Google%20Chrome%20%28Android%20%E7%89%88%29%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        Google Chrome (Android 版) 使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Google%20Chrome%20%28%E9%9B%BB%E8%85%A6%E7%89%88%29%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        Google Chrome (電腦版) 使用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Google%20Chrome%20%E5%BC%B7%E5%88%B6%E4%BD%BF%E7%94%A8%E7%B9%81%E4%B8%AD%E4%BD%9C%E7%82%BA%20UI%20%E8%AA%9E%E8%A8%80/" class="md-nav__link">
        Google Chrome 強制使用繁中作為 UI 語言 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Microsoft%20Office%20PowerPoint%20%E4%B8%8D%E8%A6%81%E9%81%B8%E5%8F%96%E6%AE%B5%E8%90%BD%E6%A8%99%E8%A8%98/" class="md-nav__link">
        Microsoft Office PowerPoint 不要選取段落標記
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Microsoft%20Office%20PowerPoint%20%E5%8C%AF%E5%87%BA%20PDF%20%E5%BE%8C%E5%9C%96%E7%89%87%E6%B6%88%E5%A4%B1/" class="md-nav__link">
        Microsoft Office PowerPoint 匯出 PDF 後圖片消失
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Microsoft%20Office%20Word%20%E4%B8%8D%E8%A6%81%E9%81%B8%E5%8F%96%E6%AE%B5%E8%90%BD%E6%A8%99%E8%A8%98/" class="md-nav__link">
        Microsoft Office Word 不要選取段落標記
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Microsoft%20Office%20Word%20%E4%BF%AE%E6%AD%A3%E8%AE%8A%E6%9B%B4%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F%E5%BE%8C%E8%A1%8C%E8%B7%9D%E8%B7%91%E6%8E%89%E7%9A%84%E5%95%8F%E9%A1%8C/" class="md-nav__link">
        Microsoft Office Word 修正變更字體大小後行距跑掉的問題
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Microsoft%20Office%20Word%20%E6%8F%92%E5%85%A5%E5%9C%96%E7%89%87%E4%B8%A6%E8%A8%AD%E7%BD%AE%E7%82%BA%E3%80%8C%E8%88%87%E6%96%87%E5%AD%97%E6%8E%92%E5%88%97%E3%80%8D%EF%BC%8C%E5%9C%96%E7%89%87%E5%8D%BB%E8%A2%AB%E5%88%87%E6%8E%89/" class="md-nav__link">
        Microsoft Office Word 插入圖片並設置為「與文字排列」，圖片卻被切掉
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/PDF%20-%20%E5%B0%87%20PDF%20%E7%9A%84%E6%89%80%E6%9C%89%E6%9B%B8%E7%B1%A4%E4%B8%80%E6%AC%A1%E6%94%B9%E7%82%BA%E6%89%BF%E8%A5%B2%E7%B8%AE%E6%94%BE/" class="md-nav__link">
        PDF: 將 PDF 的所有書籤一次改為承襲縮放
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Python%20%E5%BF%AB%E9%80%9F%E5%BB%BA%E7%AB%8B%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84%20HTTP%20%E4%BC%BA%E6%9C%8D%E5%99%A8/" class="md-nav__link">
        Python 快速建立一個簡單的 HTTP 伺服器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/VirtualBox%20-%20%E7%B8%AE%E5%B0%8F%20VirtualBox%20VDI%20%E8%99%9B%E6%93%AC%E7%A1%AC%E7%A2%9F%E6%AA%94%E5%A4%A7%E5%B0%8F/" class="md-nav__link">
        VirtualBox: 縮小 VirtualBox VDI 虛擬硬碟檔大小
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/04%20%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/Word%20%E6%96%87%E4%BB%B6%E6%A0%BC%E7%B7%9A%E8%88%87%E8%A1%8C%E8%B7%9D%E5%8E%9F%E7%90%86%EF%BC%9A%E7%82%BA%E4%BD%95%E8%AA%BF%E6%95%B4%E5%AD%97%E5%9E%8B%E6%88%96%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F%E5%BE%8C%E8%A1%8C%E8%B7%9D%E6%9C%83%E6%94%B9%E8%AE%8A%EF%BC%9F/" class="md-nav__link">
        Word 文件格線與行距原理：為何調整字型或字體大小後行距會改變？
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5" >
      
      
      
        <label class="md-nav__link" for="__nav_8_5" id="__nav_8_5_label" tabindex="0">
          05 程式設計
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_5">
          <span class="md-nav__icon md-icon"></span>
          05 程式設計
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5_1" >
      
      
      
        <label class="md-nav__link" for="__nav_8_5_1" id="__nav_8_5_1_label" tabindex="0">
          C 與 C++
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_5_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_5_1">
          <span class="md-nav__icon md-icon"></span>
          C 與 C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20Compound%20Literals/" class="md-nav__link">
        C 語言: Compound Literals
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20Compound%20Statement/" class="md-nav__link">
        C 語言: Compound Statement
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20Declaration%20and%20Definition%20%E8%88%87%20Storage-Class/" class="md-nav__link">
        C 語言: Declaration/Definition 與 Storage-Class
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20Expression%20%E8%88%87%20Statement%20%28%E8%8D%89%E7%A8%BF%29/" class="md-nav__link">
        C 語言: Expression 與 Statement
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20%E5%8F%96%E5%BE%97%E5%96%AE%E4%B8%80%E5%AD%97%E5%85%83%E7%9A%84%E5%87%BD%E6%95%B8%20-%20getchar%28%29%2C%20getch%28%29%2C%20getche%28%29/" class="md-nav__link">
        C 語言: 取得單一字元的函數: getchar(), getch(), getche()
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20%E7%9B%B4%E6%8E%A5%E5%B0%8D%20String%20literal%20%E5%81%9A%20Array%20subscripting/" class="md-nav__link">
        C 語言: 直接對 String literal 做 Array subscripting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/C%20%E8%AA%9E%E8%A8%80%20-%20%E8%B7%A8%E5%B9%B3%E5%8F%B0%20sleep%28%29/" class="md-nav__link">
        C 語言: 跨平台 sleep()
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/c-error-a-label-can-only-be-part-of-a-statement-and-a-declaration-is-not-a-statement/" class="md-nav__link">
        C語言編譯時的 a label can only be part of a statement and a declaration is not a statement 錯誤
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/cling-interactive-cpp-interpreter-tutorial/" class="md-nav__link">
        Cling: Interactive C++ Interpreter 使用指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/cpp-class-default-constructor-copy-constructor-copy-assignment-operator-and-destructor/" class="md-nav__link">
        C++ Class: default constructor, copy constructor, copy-assignment operator, and destructor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/C%20%E8%88%87%20C%2B%2B/cpp11-rvalue-reference-move-semantics-and-perfect-forwarding/" class="md-nav__link">
        C++11 右值引用、移動語意和完美轉發
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_8_5_2" id="__nav_8_5_2_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_5_2">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Java/java-compilation-and-execution/" class="md-nav__link">
        Java 編譯與執行 (TBD)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Java/java-notes/" class="md-nav__link">
        Java 筆記
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Java/java-packaging/" class="md-nav__link">
        Java 打包程式 (TBD)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Java/javafx-compilation-and-execution/" class="md-nav__link">
        JavaFX 編譯與執行
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Java/junit-5-without-buid-tools/" class="md-nav__link">
        不使用建置工具使用 JUnit 5
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_8_5_3" id="__nav_8_5_3_label" tabindex="0">
          LeetCode
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_5_3">
          <span class="md-nav__icon md-icon"></span>
          LeetCode
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-1-two-sum/" class="md-nav__link">
        [LeetCode] 1. Two Sum(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-198-house-robber/" class="md-nav__link">
        [LeetCode] 198. House Robber(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-213-house-robber-ii/" class="md-nav__link">
        [LeetCode] 213. House Robber II(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-338-counting-bits/" class="md-nav__link">
        [LeetCode] 338. Counting Bits(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-343-integer-break/" class="md-nav__link">
        [LeetCode] 343. Integer Break(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-5-longest-palindromic-substring/" class="md-nav__link">
        [LeetCode] 5. Longest Palindromic Substring(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-70-climbing-stairs/" class="md-nav__link">
        [LeetCode] 70. Climbing Stairs(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-747-largest-number-at-least-twice-of-others/" class="md-nav__link">
        [LeetCode] 747. Largest Number At Least Twice of Others(未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/LeetCode/leetcode-88-merge-sorted-array/" class="md-nav__link">
        [LeetCode] 88. Merge Sorted Array(未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5_4" >
      
      
      
        <label class="md-nav__link" for="__nav_8_5_4" id="__nav_8_5_4_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_5_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_5_4">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Python/python-execution-model/" class="md-nav__link">
        Python 執行模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Python/python-nested-module-and-relative-import/" class="md-nav__link">
        Python 巢狀 module 和 relative import
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Python/python-package-to-single-file/" class="md-nav__link">
        Python 打包資料夾成單一檔案
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5_5" >
      
      
      
        <label class="md-nav__link" for="__nav_8_5_5" id="__nav_8_5_5_label" tabindex="0">
          Text Based User Interfaces (TUI)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_5_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_5_5">
          <span class="md-nav__icon md-icon"></span>
          Text Based User Interfaces (TUI)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Text-Based%20User%20Interfaces%20%28TUI%29/Curses/" class="md-nav__link">
        Curses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/05%20%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/Text-Based%20User%20Interfaces%20%28TUI%29/%E5%8F%8D%E6%A8%B8%E6%AD%B8%E7%9C%9F%20-%20%E6%96%87%E5%AD%97%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%20%28%E8%BD%89%E8%BC%89%29/" class="md-nav__link">
        反樸歸真: 文字模式下的程式設計 (轉載)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_6" >
      
      
      
        <label class="md-nav__link" for="__nav_8_6" id="__nav_8_6_label" tabindex="0">
          06 未分類
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_6">
          <span class="md-nav__icon md-icon"></span>
          06 未分類
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/06%20%E6%9C%AA%E5%88%86%E9%A1%9E/Linux%20%E5%92%8C%20Windows%20%E6%AA%94%E6%A1%88%E5%90%8D%E7%A8%B1%E5%AD%97%E5%85%83%E9%99%90%E5%88%B6/" class="md-nav__link">
        Linux 和 Windows 檔案名稱字元限制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/06%20%E6%9C%AA%E5%88%86%E9%A1%9E/MM%20Sorting%20Machine/" class="md-nav__link">
        M&M Sorting Machine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/06%20%E6%9C%AA%E5%88%86%E9%A1%9E/Noto%20CJK%20%E5%92%8C%20Source%20Han%20%E5%AD%97%E5%9E%8B%E6%AF%94%E8%BC%83/" class="md-nav__link">
        Noto CJK 和 Source Han 字型比較 (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/06%20%E6%9C%AA%E5%88%86%E9%A1%9E/%E4%BD%BF%E7%94%A8%20FFmpeg%20%E4%B8%8B%E8%BC%89%20HLS%20%28m3u8%29%20%E4%B8%B2%E6%B5%81%E5%BD%B1%E7%89%87/" class="md-nav__link">
        使用 FFmpeg 下載 HLS (m3u8) 串流影片
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../08%20%E9%9B%BB%E8%85%A6%E5%AF%A6%E5%8B%99/06%20%E6%9C%AA%E5%88%86%E9%A1%9E/%E9%96%8B%E6%BA%90%E4%BA%BA%E5%B9%B4%E6%9C%83%20COSCUP%202018%20%E6%9C%83%E5%BE%8C%E7%AD%86%E8%A8%98/" class="md-nav__link">
        開源人年會 COSCUP 2018 會後筆記 (未完成)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          10 其他
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          10 其他
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10%20%E5%85%B6%E4%BB%96/%5B%E6%97%A5%E8%AA%9E%E7%B7%B4%E7%BF%92-%E6%AD%8C%E8%A9%9E%E7%BF%BB%E8%AD%AF%5D%20%E5%83%95%E3%81%8C%E6%AD%BB%E3%81%AE%E3%81%86%E3%81%A8%E6%80%9D%E3%81%A3%E3%81%9F%E3%81%AE%E3%81%AF/" class="md-nav__link">
        [日語練習-歌詞翻譯] 僕が死のうと思ったのは (未完成)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10%20%E5%85%B6%E4%BB%96/%E4%BD%BF%E7%94%A8%E7%A4%BA%E6%B3%A2%E5%99%A8%20XY%20%E6%A8%A1%E5%BC%8F%E7%95%AB%E5%9C%96/" class="md-nav__link">
        使用示波器 XY 模式畫圖
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" >
      
      
      
        <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="0">
          網站除錯
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9_3">
          <span class="md-nav__icon md-icon"></span>
          網站除錯
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10%20%E5%85%B6%E4%BB%96/%E7%B6%B2%E7%AB%99%E9%99%A4%E9%8C%AF/" class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../10%20%E5%85%B6%E4%BB%96/%E7%B6%B2%E7%AB%99%E9%99%A4%E9%8C%AF/debug/" class="md-nav__link">
        網頁 Debug
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#device" class="md-nav__link">
    Device
  </a>
  
    <nav class="md-nav" aria-label="Device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-number" class="md-nav__link">
    設備號 (device number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    註冊裝置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    更高級的抽象裝置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-driver" class="md-nav__link">
    Device driver
  </a>
  
    <nav class="md-nav" aria-label="Device driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-driver_1" class="md-nav__link">
    註冊 device driver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-driver_2" class="md-nav__link">
    載入 device driver
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#character-device" class="md-nav__link">
    Character device
  </a>
  
    <nav class="md-nav" aria-label="Character device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#character-device_1" class="md-nav__link">
    註冊 character device
  </a>
  
    <nav class="md-nav" aria-label="註冊 character device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-character-device-table" class="md-nav__link">
    System character device table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#driver" class="md-nav__link">
    註冊 driver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    註冊裝置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#character-device_2" class="md-nav__link">
    註冊 character device
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#block-device" class="md-nav__link">
    Block device
  </a>
  
    <nav class="md-nav" aria-label="Block device">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    資料結構
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#driver_1" class="md-nav__link">
    註冊 driver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-device_1" class="md-nav__link">
    註冊裝置和註冊 block device
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-file" class="md-nav__link">
    存取 device file
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="linux-kernel-device-device-driver">Linux kernel: Device 及 Device driver</h1>
<h2 id="device">Device</h2>
<h3 id="device-number">設備號 (device number)</h3>
<p>Linux kernel 通過設備號 (device number) 來分辨具體的設備，設備號包含以下 2 個數字：</p>
<ul>
<li>major number: 代表 device driver，通常一個 device driver 使用一個 major number<ul>
<li>但如果 device driver 用不到全部的 minor number，也可以多個 device driver 共用一個 major number</li>
<li>反過來說，如果 device driver 需要的 minor number 數超過上限，也可以註冊多個 major number</li>
</ul>
</li>
<li>minor number: 通常代表使用該 device driver 的不同設備，或同一設備的不同功能<ul>
<li>例如：兩個同樣界面的硬碟，會使用相同的 major number (因為使用相同 device driver) 但不同 minor number 來區分</li>
<li>例如：同一個硬碟的不同分區，亦會使用相同的 major number (因為使用相同 device driver) 但不同 minor number 來區分</li>
</ul>
</li>
</ul>
<p>major number 和 minor number 使用 <code>dev_t</code> 型別儲存。</p>
<p><code>dev_t</code> 本質上是個 unsigned 32-bit integer。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/types.h</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">__kernel_dev_t</span><span class="p">;</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">__kernel_dev_t</span><span class="w">      </span><span class="kt">dev_t</span><span class="p">;</span>
</code></pre></div>
<p><code>dev_t</code> 的 higher 12 bit 儲存 major number，lower 20 bit 儲存 minor number。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/kdev_t.h</span>
<span class="cp">#define MINORBITS   20</span>
<span class="cp">#define MINORMASK   ((1U &lt;&lt; MINORBITS) - 1)</span>

<span class="cp">#define MAJOR(dev)  ((unsigned int) ((dev) &gt;&gt; MINORBITS))</span>
<span class="cp">#define MINOR(dev)  ((unsigned int) ((dev) &amp; MINORMASK))</span>
<span class="cp">#define MKDEV(ma,mi)    (((ma) &lt;&lt; MINORBITS) | (mi))</span>
</code></pre></div>
<p>由於向 kernel 註冊設備號時，只能以連續的 minor number 進行註冊 (當然，也可以註冊多次來獲得不連續的 minor number)，所以常會在資料結構或函式呼叫中看見 <code>"開頭設備號 (major, minor_start)" + "幾個設備號 (count)"</code> 這樣的形式。</p>
<p>這樣的形式代表一個設備號範圍：</p>
<div class="highlight"><pre><span></span><code>(major, minor_start)
(major, minor_start + 1)
(major, minor_start + 2)
...
(major, minor_start + (count - 1))
</code></pre></div>
<h3 id="_1">資料結構</h3>
<p>每個 device 由一個 <code>struct device</code> 表示。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/device.h</span>
<span class="cm">/**</span>
<span class="cm"> * struct device - The basic device structure</span>
<span class="cm"> * @parent: The device's "parent" device, the device to which it is attached.</span>
<span class="cm"> *      In most cases, a parent device is some sort of bus or host</span>
<span class="cm"> *      controller. If parent is NULL, the device, is a top-level device,</span>
<span class="cm"> *      which is not usually what you want.</span>
<span class="cm"> * @p:      Holds the private data of the driver core portions of the device.</span>
<span class="cm"> *      See the comment of the struct device_private for detail.</span>
<span class="cm"> * @kobj:   A top-level, abstract class from which other classes are derived.</span>
<span class="cm"> * @init_name:  Initial name of the device.</span>
<span class="cm"> * @type:   The type of device.</span>
<span class="cm"> *      This identifies the device type and carries type-specific</span>
<span class="cm"> *      information.</span>
<span class="cm"> * @mutex:  Mutex to synchronize calls to its driver.</span>
<span class="cm"> * @lockdep_mutex: An optional debug lock that a subsystem can use as a</span>
<span class="cm"> *      peer lock to gain localized lockdep coverage of the device_lock.</span>
<span class="cm"> * @bus:    Type of bus device is on.</span>
<span class="cm"> * @driver: Which driver has allocated this</span>
<span class="cm"> * @platform_data: Platform data specific to the device.</span>
<span class="cm"> *      Example: For devices on custom boards, as typical of embedded</span>
<span class="cm"> *      and SOC based hardware, Linux often uses platform_data to point</span>
<span class="cm"> *      to board-specific structures describing devices and how they</span>
<span class="cm"> *      are wired.  That can include what ports are available, chip</span>
<span class="cm"> *      variants, which GPIO pins act in what additional roles, and so</span>
<span class="cm"> *      on.  This shrinks the "Board Support Packages" (BSPs) and</span>
<span class="cm"> *      minimizes board-specific #ifdefs in drivers.</span>
<span class="cm"> * @driver_data: Private pointer for driver specific info.</span>
<span class="cm"> * @links:  Links to suppliers and consumers of this device.</span>
<span class="cm"> * @power:  For device power management.</span>
<span class="cm"> *      See Documentation/driver-api/pm/devices.rst for details.</span>
<span class="cm"> * @pm_domain:  Provide callbacks that are executed during system suspend,</span>
<span class="cm"> *      hibernation, system resume and during runtime PM transitions</span>
<span class="cm"> *      along with subsystem-level and driver-level callbacks.</span>
<span class="cm"> * @em_pd:  device's energy model performance domain</span>
<span class="cm"> * @pins:   For device pin management.</span>
<span class="cm"> *      See Documentation/driver-api/pin-control.rst for details.</span>
<span class="cm"> * @msi:    MSI related data</span>
<span class="cm"> * @numa_node:  NUMA node this device is close to.</span>
<span class="cm"> * @dma_ops:    DMA mapping operations for this device.</span>
<span class="cm"> * @dma_mask:   Dma mask (if dma'ble device).</span>
<span class="cm"> * @coherent_dma_mask: Like dma_mask, but for alloc_coherent mapping as not all</span>
<span class="cm"> *      hardware supports 64-bit addresses for consistent allocations</span>
<span class="cm"> *      such descriptors.</span>
<span class="cm"> * @bus_dma_limit: Limit of an upstream bridge or bus which imposes a smaller</span>
<span class="cm"> *      DMA limit than the device itself supports.</span>
<span class="cm"> * @dma_range_map: map for DMA memory ranges relative to that of RAM</span>
<span class="cm"> * @dma_parms:  A low level driver may set these to teach IOMMU code about</span>
<span class="cm"> *      segment limitations.</span>
<span class="cm"> * @dma_pools:  Dma pools (if dma'ble device).</span>
<span class="cm"> * @dma_mem:    Internal for coherent mem override.</span>
<span class="cm"> * @cma_area:   Contiguous memory area for dma allocations</span>
<span class="cm"> * @dma_io_tlb_mem: Pointer to the swiotlb pool used.  Not for driver use.</span>
<span class="cm"> * @archdata:   For arch-specific additions.</span>
<span class="cm"> * @of_node:    Associated device tree node.</span>
<span class="cm"> * @fwnode: Associated device node supplied by platform firmware.</span>
<span class="cm"> * @devt:   For creating the sysfs "dev".</span>
<span class="cm"> * @id:     device instance</span>
<span class="cm"> * @devres_lock: Spinlock to protect the resource of the device.</span>
<span class="cm"> * @devres_head: The resources list of the device.</span>
<span class="cm"> * @knode_class: The node used to add the device to the class list.</span>
<span class="cm"> * @class:  The class of the device.</span>
<span class="cm"> * @groups: Optional attribute groups.</span>
<span class="cm"> * @release:    Callback to free the device after all references have</span>
<span class="cm"> *      gone away. This should be set by the allocator of the</span>
<span class="cm"> *      device (i.e. the bus driver that discovered the device).</span>
<span class="cm"> * @iommu_group: IOMMU group the device belongs to.</span>
<span class="cm"> * @iommu:  Per device generic IOMMU runtime data</span>
<span class="cm"> * @removable:  Whether the device can be removed from the system. This</span>
<span class="cm"> *              should be set by the subsystem / bus driver that discovered</span>
<span class="cm"> *              the device.</span>
<span class="cm"> *</span>
<span class="cm"> * @offline_disabled: If set, the device is permanently online.</span>
<span class="cm"> * @offline:    Set after successful invocation of bus type's .offline().</span>
<span class="cm"> * @of_node_reused: Set if the device-tree node is shared with an ancestor</span>
<span class="cm"> *              device.</span>
<span class="cm"> * @state_synced: The hardware state of this device has been synced to match</span>
<span class="cm"> *        the software state of this device by calling the driver/bus</span>
<span class="cm"> *        sync_state() callback.</span>
<span class="cm"> * @can_match:  The device has matched with a driver at least once or it is in</span>
<span class="cm"> *      a bus (like AMBA) which can't check for matching drivers until</span>
<span class="cm"> *      other devices probe successfully.</span>
<span class="cm"> * @dma_coherent: this particular device is dma coherent, even if the</span>
<span class="cm"> *      architecture supports non-coherent devices.</span>
<span class="cm"> * @dma_ops_bypass: If set to %true then the dma_ops are bypassed for the</span>
<span class="cm"> *      streaming DMA operations (-&gt;map_* / -&gt;unmap_* / -&gt;sync_*),</span>
<span class="cm"> *      and optionall (if the coherent mask is large enough) also</span>
<span class="cm"> *      for dma allocations.  This flag is managed by the dma ops</span>
<span class="cm"> *      instance from -&gt;dma_supported.</span>
<span class="cm"> *</span>
<span class="cm"> * At the lowest level, every device in a Linux system is represented by an</span>
<span class="cm"> * instance of struct device. The device structure contains the information</span>
<span class="cm"> * that the device model core needs to model the system. Most subsystems,</span>
<span class="cm"> * however, track additional information about the devices they host. As a</span>
<span class="cm"> * result, it is rare for devices to be represented by bare device structures;</span>
<span class="cm"> * instead, that structure, like kobject structures, is usually embedded within</span>
<span class="cm"> * a higher-level representation of the device.</span>
<span class="cm"> */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w">       </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_private</span><span class="w">   </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">      </span><span class="o">*</span><span class="n">init_name</span><span class="p">;</span><span class="w"> </span><span class="cm">/* initial name of the device */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bus_type</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="p">;</span><span class="w">       </span><span class="cm">/* type of bus device is on */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">;</span><span class="w">   </span><span class="cm">/* which driver has allocated this</span>
<span class="cm">                       device */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">        </span><span class="o">*</span><span class="n">platform_data</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Platform specific data, device</span>
<span class="cm">                       core doesn't touch it */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">        </span><span class="o">*</span><span class="n">driver_data</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Driver data, set and get with</span>
<span class="cm">                       dev_set_drvdata/dev_get_drvdata */</span>
<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">        </span><span class="n">lockdep_mutex</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">        </span><span class="n">mutex</span><span class="p">;</span><span class="w">  </span><span class="cm">/* mutex to synchronize calls to</span>
<span class="cm">                     * its driver.</span>
<span class="cm">                     */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_links_info</span><span class="w">   </span><span class="n">links</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_info</span><span class="w">  </span><span class="n">power</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_domain</span><span class="w">    </span><span class="o">*</span><span class="n">pm_domain</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ENERGY_MODEL</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">em_perf_domain</span><span class="w">   </span><span class="o">*</span><span class="n">em_pd</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PINCTRL</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pin_info</span><span class="w"> </span><span class="o">*</span><span class="n">pins</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_msi_info</span><span class="w"> </span><span class="n">msi</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DMA_OPS</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dma_map_ops</span><span class="w"> </span><span class="o">*</span><span class="n">dma_ops</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">u64</span><span class="w">     </span><span class="o">*</span><span class="n">dma_mask</span><span class="p">;</span><span class="w">  </span><span class="cm">/* dma mask (if dma'able device) */</span>
<span class="w">    </span><span class="n">u64</span><span class="w">     </span><span class="n">coherent_dma_mask</span><span class="p">;</span><span class="cm">/* Like dma_mask, but for</span>
<span class="cm">                         alloc_coherent mappings as</span>
<span class="cm">                         not all hardware supports</span>
<span class="cm">                         64 bit addresses for consistent</span>
<span class="cm">                         allocations such descriptors. */</span>
<span class="w">    </span><span class="n">u64</span><span class="w">     </span><span class="n">bus_dma_limit</span><span class="p">;</span><span class="w">  </span><span class="cm">/* upstream dma constraint */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bus_dma_region</span><span class="w"> </span><span class="o">*</span><span class="n">dma_range_map</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_dma_parameters</span><span class="w"> </span><span class="o">*</span><span class="n">dma_parms</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">dma_pools</span><span class="p">;</span><span class="w">  </span><span class="cm">/* dma pools (if dma'ble) */</span>

<span class="cp">#ifdef CONFIG_DMA_DECLARE_COHERENT</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dma_coherent_mem</span><span class="w"> </span><span class="o">*</span><span class="n">dma_mem</span><span class="p">;</span><span class="w"> </span><span class="cm">/* internal for coherent mem</span>
<span class="cm">                         override */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_DMA_CMA</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cma</span><span class="w"> </span><span class="o">*</span><span class="n">cma_area</span><span class="p">;</span><span class="w">       </span><span class="cm">/* contiguous memory area for dma</span>
<span class="cm">                       allocations */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SWIOTLB</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">io_tlb_mem</span><span class="w"> </span><span class="o">*</span><span class="n">dma_io_tlb_mem</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="cm">/* arch specific additions */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_archdata</span><span class="w"> </span><span class="n">archdata</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w">  </span><span class="o">*</span><span class="n">of_node</span><span class="p">;</span><span class="w"> </span><span class="cm">/* associated device tree node */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fwnode_handle</span><span class="w">    </span><span class="o">*</span><span class="n">fwnode</span><span class="p">;</span><span class="w"> </span><span class="cm">/* firmware device node */</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">numa_node</span><span class="p">;</span><span class="w">  </span><span class="cm">/* NUMA node this device is close to */</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">           </span><span class="n">devt</span><span class="p">;</span><span class="w">   </span><span class="cm">/* dev_t, creates the sysfs "dev" */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">         </span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="cm">/* device instance */</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">devres_lock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">devres_head</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">class</span><span class="w">        </span><span class="o">*</span><span class="n">class</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">groups</span><span class="p">;</span><span class="w">  </span><span class="cm">/* optional groups */</span>

<span class="w">    </span><span class="kt">void</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iommu_group</span><span class="w">  </span><span class="o">*</span><span class="n">iommu_group</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_iommu</span><span class="w">    </span><span class="o">*</span><span class="n">iommu</span><span class="p">;</span>

<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">device_removable</span><span class="w">   </span><span class="n">removable</span><span class="p">;</span>

<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">offline_disabled</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">offline</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">of_node_reused</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">state_synced</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">can_match</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_DEVICE) || \</span>
<span class="cp">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU) || \</span>
<span class="cp">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU_ALL)</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">dma_coherent</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_DMA_OPS_BYPASS</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">dma_ops_bypass</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="_2">註冊裝置</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /drivers/base/core.c</span>
<span class="cm">/**</span>
<span class="cm"> * device_register - register a device with the system.</span>
<span class="cm"> * @dev: pointer to the device structure</span>
<span class="cm"> *</span>
<span class="cm"> * This happens in two clean steps - initialize the device</span>
<span class="cm"> * and add it to the system. The two steps can be called</span>
<span class="cm"> * separately, but this is the easiest and most common.</span>
<span class="cm"> * I.e. you should only call the two helpers separately if</span>
<span class="cm"> * have a clearly defined need to use and refcount the device</span>
<span class="cm"> * before it is added to the hierarchy.</span>
<span class="cm"> *</span>
<span class="cm"> * For more information, see the kerneldoc for device_initialize()</span>
<span class="cm"> * and device_add().</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: _Never_ directly free @dev after calling this function, even</span>
<span class="cm"> * if it returned an error! Always use put_device() to give up the</span>
<span class="cm"> * reference initialized in this function instead.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">device_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">device_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">device_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /drivers/base/core.c</span>
<span class="cm">/**</span>
<span class="cm"> * device_initialize - init device structure.</span>
<span class="cm"> * @dev: device.</span>
<span class="cm"> *</span>
<span class="cm"> * This prepares the device for use by other layers by initializing</span>
<span class="cm"> * its fields.</span>
<span class="cm"> * It is the first half of device_register(), if called by</span>
<span class="cm"> * that function, though it can also be called separately, so one</span>
<span class="cm"> * may use @dev's fields. In particular, get_device()/put_device()</span>
<span class="cm"> * may be used for reference counting of @dev after calling this</span>
<span class="cm"> * function.</span>
<span class="cm"> *</span>
<span class="cm"> * All fields in @dev must be initialized by the caller to 0, except</span>
<span class="cm"> * for those explicitly set to some other value.  The simplest</span>
<span class="cm"> * approach is to use kzalloc() to allocate the structure containing</span>
<span class="cm"> * @dev.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Use put_device() to give up your reference instead of freeing</span>
<span class="cm"> * @dev directly once you have called this function.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">device_initialize</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">kset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devices_kset</span><span class="p">;</span>
<span class="w">    </span><span class="n">kobject_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">device_ktype</span><span class="p">);</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_pools</span><span class="p">);</span>
<span class="w">    </span><span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
<span class="w">    </span><span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lockdep_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">lockdep_set_novalidate_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devres_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devres_head</span><span class="p">);</span>
<span class="w">    </span><span class="n">device_pm_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">set_dev_node</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">NUMA_NO_NODE</span><span class="p">);</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">.</span><span class="n">consumers</span><span class="p">);</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">.</span><span class="n">suppliers</span><span class="p">);</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">.</span><span class="n">defer_sync</span><span class="p">);</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DL_DEV_NO_DRIVER</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_DEVICE) || \</span>
<span class="cp">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU) || \</span>
<span class="cp">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU_ALL)</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_coherent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_default_coherent</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SWIOTLB</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_io_tlb_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">io_tlb_default_mem</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /drivers/base/core.c</span>
<span class="cm">/**</span>
<span class="cm"> * device_add - add device to device hierarchy.</span>
<span class="cm"> * @dev: device.</span>
<span class="cm"> *</span>
<span class="cm"> * This is part 2 of device_register(), though may be called</span>
<span class="cm"> * separately _iff_ device_initialize() has been called separately.</span>
<span class="cm"> *</span>
<span class="cm"> * This adds @dev to the kobject hierarchy via kobject_add(), adds it</span>
<span class="cm"> * to the global and sibling lists for the device, then</span>
<span class="cm"> * adds it to the other relevant subsystems of the driver model.</span>
<span class="cm"> *</span>
<span class="cm"> * Do not call this routine or device_register() more than once for</span>
<span class="cm"> * any device structure.  The driver model core is not designed to work</span>
<span class="cm"> * with devices that get unregistered and then spring back to life.</span>
<span class="cm"> * (Among other things, it's very hard to guarantee that all references</span>
<span class="cm"> * to the previous incarnation of @dev have been dropped.)  Allocate</span>
<span class="cm"> * and register a fresh new struct device instead.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: _Never_ directly free @dev after calling this function, even</span>
<span class="cm"> * if it returned an error! Always use put_device() to give up your</span>
<span class="cm"> * reference instead.</span>
<span class="cm"> *</span>
<span class="cm"> * Rule of thumb is: if device_add() succeeds, you should call</span>
<span class="cm"> * device_del() when you want to get rid of it. If device_add() has</span>
<span class="cm"> * *not* succeeded, use *only* put_device() to drop the reference</span>
<span class="cm"> * count.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">device_add</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">class_interface</span><span class="w"> </span><span class="o">*</span><span class="n">class_intf</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">glue_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_private_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * for statically allocated devices, which should all be converted</span>
<span class="cm">     * some day, we need to initialize the name. We prevent reading back</span>
<span class="cm">     * the name, and force the use of dev_name()</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">"%s"</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_name</span><span class="p">);</span>
<span class="w">        </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* subsystems can specify simple device enumeration */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">)</span>
<span class="w">        </span><span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">"%s%u"</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">name_error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">pr_debug</span><span class="p">(</span><span class="s">"device: '%s': %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span>

<span class="w">    </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="w">    </span><span class="n">kobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_device_parent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">kobj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">parent_error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kobj</span><span class="p">)</span>
<span class="w">        </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* use parent numa_node */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NUMA_NO_NODE</span><span class="p">))</span>
<span class="w">        </span><span class="n">set_dev_node</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">dev_to_node</span><span class="p">(</span><span class="n">parent</span><span class="p">));</span>

<span class="w">    </span><span class="cm">/* first, register with generic layer. */</span>
<span class="w">    </span><span class="cm">/* we require the name to be set before, and pass NULL */</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobject_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">glue_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_glue_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">Error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* notify platform of device entry */</span>
<span class="w">    </span><span class="n">device_platform_notify</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev_attr_uevent</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">attrError</span><span class="p">;</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_add_class_symlinks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">SymlinkError</span><span class="p">;</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_add_attrs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">AttrsError</span><span class="p">;</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bus_add_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">BusError</span><span class="p">;</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dpm_sysfs_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">DPMError</span><span class="p">;</span>
<span class="w">    </span><span class="n">device_pm_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev_attr_dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">DevAttrError</span><span class="p">;</span>

<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_create_sys_dev_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">SysEntryError</span><span class="p">;</span>

<span class="w">        </span><span class="n">devtmpfs_create_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Notify clients of device addition.  This call must come</span>
<span class="cm">     * after dpm_sysfs_add() and before kobject_uevent().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
<span class="w">        </span><span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bus_notifier</span><span class="p">,</span>
<span class="w">                         </span><span class="n">BUS_NOTIFY_ADD_DEVICE</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">KOBJ_ADD</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Check if any of the other devices (consumers) have been waiting for</span>
<span class="cm">     * this device (supplier) to be added so that they can create a device</span>
<span class="cm">     * link to it.</span>
<span class="cm">     *</span>
<span class="cm">     * This needs to happen after device_pm_add() because device_link_add()</span>
<span class="cm">     * requires the supplier be registered before it's called.</span>
<span class="cm">     *</span>
<span class="cm">     * But this also needs to happen before bus_probe_device() to make sure</span>
<span class="cm">     * waiting consumers can link to it before the driver is bound to the</span>
<span class="cm">     * device and the driver sync_state callback is called for this device.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fwnode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fwnode</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fwnode</span><span class="o">-&gt;</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span>
<span class="w">        </span><span class="n">fw_devlink_link_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">bus_probe_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If all driver registration is done and a newly added device doesn't</span>
<span class="cm">     * match with any driver, don't block its consumers from probing in</span>
<span class="cm">     * case the consumer device is able to operate without this supplier.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fwnode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fw_devlink_drv_reg_done</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">can_match</span><span class="p">)</span>
<span class="w">        </span><span class="n">fw_devlink_unblock_consumers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
<span class="w">        </span><span class="n">klist_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">knode_parent</span><span class="p">,</span>
<span class="w">                   </span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">klist_children</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* tie the class to the device */</span>
<span class="w">        </span><span class="n">klist_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">knode_class</span><span class="p">,</span>
<span class="w">                   </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">klist_devices</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* notify any interfaces that the device is here */</span>
<span class="w">        </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">class_intf</span><span class="p">,</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">class_intf</span><span class="o">-&gt;</span><span class="n">add_dev</span><span class="p">)</span>
<span class="w">                </span><span class="n">class_intf</span><span class="o">-&gt;</span><span class="n">add_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">class_intf</span><span class="p">);</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="nl">done</span><span class="p">:</span>
<span class="w">    </span><span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w"> </span><span class="nl">SysEntryError</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">))</span>
<span class="w">        </span><span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev_attr_dev</span><span class="p">);</span>
<span class="w"> </span><span class="nl">DevAttrError</span><span class="p">:</span>
<span class="w">    </span><span class="n">device_pm_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">dpm_sysfs_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w"> </span><span class="nl">DPMError</span><span class="p">:</span>
<span class="w">    </span><span class="n">bus_remove_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w"> </span><span class="nl">BusError</span><span class="p">:</span>
<span class="w">    </span><span class="n">device_remove_attrs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w"> </span><span class="nl">AttrsError</span><span class="p">:</span>
<span class="w">    </span><span class="n">device_remove_class_symlinks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w"> </span><span class="nl">SymlinkError</span><span class="p">:</span>
<span class="w">    </span><span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev_attr_uevent</span><span class="p">);</span>
<span class="w"> </span><span class="nl">attrError</span><span class="p">:</span>
<span class="w">    </span><span class="n">device_platform_notify_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">KOBJ_REMOVE</span><span class="p">);</span>
<span class="w">    </span><span class="n">glue_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_glue_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="w"> </span><span class="nl">Error</span><span class="p">:</span>
<span class="w">    </span><span class="n">cleanup_glue_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">glue_dir</span><span class="p">);</span>
<span class="nl">parent_error</span><span class="p">:</span>
<span class="w">    </span><span class="n">put_device</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="nl">name_error</span><span class="p">:</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_3">更高級的抽象裝置</h3>
<p>Device driver 通常不會直接使用 <code>struct device</code>，而是使用 kernel 提供的更高級的抽象裝置: character device 和 block device (之後會介紹)。</p>
<h2 id="device-driver">Device driver</h2>
<h3 id="_4">資料結構</h3>
<p>每個 device 由一個 <code>struct device_driver</code> 表示。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/device/driver.h</span>
<span class="cm">/**</span>
<span class="cm"> * struct device_driver - The basic device driver structure</span>
<span class="cm"> * @name:   Name of the device driver.</span>
<span class="cm"> * @bus:    The bus which the device of this driver belongs to.</span>
<span class="cm"> * @owner:  The module owner.</span>
<span class="cm"> * @mod_name:   Used for built-in modules.</span>
<span class="cm"> * @suppress_bind_attrs: Disables bind/unbind via sysfs.</span>
<span class="cm"> * @probe_type: Type of the probe (synchronous or asynchronous) to use.</span>
<span class="cm"> * @of_match_table: The open firmware table.</span>
<span class="cm"> * @acpi_match_table: The ACPI match table.</span>
<span class="cm"> * @probe:  Called to query the existence of a specific device,</span>
<span class="cm"> *      whether this driver can work with it, and bind the driver</span>
<span class="cm"> *      to a specific device.</span>
<span class="cm"> * @sync_state: Called to sync device state to software state after all the</span>
<span class="cm"> *      state tracking consumers linked to this device (present at</span>
<span class="cm"> *      the time of late_initcall) have successfully bound to a</span>
<span class="cm"> *      driver. If the device has no consumers, this function will</span>
<span class="cm"> *      be called at late_initcall_sync level. If the device has</span>
<span class="cm"> *      consumers that are never bound to a driver, this function</span>
<span class="cm"> *      will never get called until they do.</span>
<span class="cm"> * @remove: Called when the device is removed from the system to</span>
<span class="cm"> *      unbind a device from this driver.</span>
<span class="cm"> * @shutdown:   Called at shut-down time to quiesce the device.</span>
<span class="cm"> * @suspend:    Called to put the device to sleep mode. Usually to a</span>
<span class="cm"> *      low power state.</span>
<span class="cm"> * @resume: Called to bring a device from sleep mode.</span>
<span class="cm"> * @groups: Default attributes that get created by the driver core</span>
<span class="cm"> *      automatically.</span>
<span class="cm"> * @dev_groups: Additional attributes attached to device instance once</span>
<span class="cm"> *      it is bound to the driver.</span>
<span class="cm"> * @pm:     Power management operations of the device which matched</span>
<span class="cm"> *      this driver.</span>
<span class="cm"> * @coredump:   Called when sysfs entry is written to. The device driver</span>
<span class="cm"> *      is expected to call the dev_coredump API resulting in a</span>
<span class="cm"> *      uevent.</span>
<span class="cm"> * @p:      Driver core's private data, no one other than the driver</span>
<span class="cm"> *      core can touch this.</span>
<span class="cm"> *</span>
<span class="cm"> * The device driver-model tracks all of the drivers known to the system.</span>
<span class="cm"> * The main reason for this tracking is to enable the driver core to match</span>
<span class="cm"> * up drivers with new devices. Once drivers are known objects within the</span>
<span class="cm"> * system, however, a number of other things become possible. Device drivers</span>
<span class="cm"> * can export information and configuration variables that are independent</span>
<span class="cm"> * of any specific device.</span>
<span class="cm"> */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">      </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bus_type</span><span class="w">     </span><span class="o">*</span><span class="n">bus</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w">       </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">      </span><span class="o">*</span><span class="n">mod_name</span><span class="p">;</span><span class="w">  </span><span class="cm">/* used for built-in modules */</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">suppress_bind_attrs</span><span class="p">;</span><span class="w">   </span><span class="cm">/* disables bind/unbind via sysfs */</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">probe_type</span><span class="w"> </span><span class="n">probe_type</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">of_device_id</span><span class="w">   </span><span class="o">*</span><span class="n">of_match_table</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">acpi_match_table</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sync_state</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">pm_message_t</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">groups</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">dev_groups</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_ops</span><span class="w"> </span><span class="o">*</span><span class="n">pm</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">coredump</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">driver_private</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="device-driver_1">註冊 device driver</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /drivers/base/driver.c</span>
<span class="cm">/**</span>
<span class="cm"> * driver_register - register driver with bus</span>
<span class="cm"> * @drv: driver to register</span>
<span class="cm"> *</span>
<span class="cm"> * We pass off most of the work to the bus_add_driver() call,</span>
<span class="cm"> * since most of the things we have to do deal with the bus</span>
<span class="cm"> * structures.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">driver_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="o">*</span><span class="n">other</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"Driver '%s' was unable to register with bus_type '%s' because the bus was not initialized.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">probe</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">remove</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">))</span>
<span class="w">        </span><span class="n">pr_warn</span><span class="p">(</span><span class="s">"Driver '%s' needs updating - please use "</span>
<span class="w">            </span><span class="s">"bus_type methods</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="n">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver_find</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"Error: Driver '%s' is already registered, "</span>
<span class="w">            </span><span class="s">"aborting...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bus_add_driver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver_add_groups</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span><span class="w"> </span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bus_remove_driver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">KOBJ_ADD</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="device-driver_2">載入 device driver</h3>
<p>Device driver 是一種 kernel module，見 <a href="Linux kernel module 載入流程.md">Linux kernel module 載入流程</a></p>
<h2 id="character-device">Character device</h2>
<h3 id="_5">資料結構</h3>
<p>每個 character device 由一個 <code>struct cdev</code> 表示。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/cdev.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span><span class="w">    </span><span class="c1">// 指向負責進行真正的裝置操作的函數</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">             </span><span class="c1">// 第一個 major number 和 minor number</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">    </span><span class="c1">// 總共幾個 minor number</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<p><code>struct file_operations</code> 指向負責進行真正的裝置操作的函數。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/fs.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>
<h3 id="character-device_1">註冊 character device</h3>
<div class="highlight"><pre><span></span><code>                query                                          point to
device file --------------&gt; system character device table ------------------&gt; device driver
                                      cdev_map                                 struct cdev
</code></pre></div>
<h4 id="system-character-device-table">System character device table</h4>
<p>本文分析的 Linux kernel 5.18.6 有 2 個同時存在的 system character device table: </p>
<ul>
<li>
<p>由 <code>register_chrdev_region()</code> 或 <code>alloc_chrdev_region()</code> 註冊的 <code>chrdevs</code></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="cp">#define CHRDEV_MAJOR_HASH_SIZE 255</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">baseminor</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minorct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">cdev</span><span class="p">;</span><span class="w">      </span><span class="cm">/* will die */</span>
<span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">chrdevs</span><span class="p">[</span><span class="n">CHRDEV_MAJOR_HASH_SIZE</span><span class="p">];</span>
</code></pre></div>
<p><code>chrdevs</code> 只有註冊相關函數和 <code>chrdev_show()</code> 會用到。那麼誰會呼叫 <code>chrdev_show()</code>呢？只有 procfs 的 <code>devinfo_show()</code>。</p>
</li>
<li>
<p>由 <code>cdev_add()</code> 註冊的 <code>cdev_map</code></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_map</span><span class="w"> </span><span class="o">*</span><span class="n">cdev_map</span><span class="p">;</span>

<span class="c1">// Linux kernel 5.18.6 /drivers/base/map.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kobj_map</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">              </span><span class="c1">// 第一個 major number 和 minor number，相當於 `struct char_device_struct` 的 `(major, baseminor)`</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">range</span><span class="p">;</span><span class="w">    </span><span class="c1">// 總共幾個 minor number，相當於 `struct char_device_struct` 的 `minorct`</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">        </span><span class="n">kobj_probe_t</span><span class="w"> </span><span class="o">*</span><span class="n">get</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)(</span><span class="kt">dev_t</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w">    </span><span class="c1">// 這裡會指向 `struct cdev`!</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">probes</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<p>可以看到 <code>cdev_map</code> 幾乎完全包含了 <code>chrdevs</code>，但只有 <code>chrdevs</code> 有儲存 device driver 的名字 (member <code>char name[64]</code>)。</p>
<p><strong>問題</strong>: 這樣還需要 <code>chrdevs</code> 嗎？不執行 <code>register_chrdev_region()</code> 或 <code>alloc_chrdev_region()</code> 也可以嗎？</p>
<p>如果所有設備都不需要動態分配設備號的話或許可以 (沒試過，也沒有查到相關資料)。</p>
<p>但如果至少有一個設備需要動態分配設備號，就一定需要 <code>chrdevs</code>。</p>
<p>因為 <code>cdev_add()</code> 的參數需要設備號，而動態分配設備號是從 <code>alloc_chrdev_region()</code> 內部呼叫的 <code>find_dynamic_major()</code> 而來，<code>find_dynamic_major()</code> 會從 <code>chrdevs</code> 找出尚未使用的設備號。</p>
<p>如果有一個手動指定設備號的裝置沒有執行 <code>register_chrdev_region()</code> 向 <code>chrdevs</code> 註冊，之後新裝置若使用動態分配設備號，就有可能重複用到剛剛手動指定的設備號，導致出錯。</p>
<h4 id="driver">註冊 driver</h4>
<p>註冊設備號可以使用 <code>register_chrdev_region()</code> 或 <code>alloc_chrdev_region()</code>，以下分別節選其程式碼：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fs.h&gt;</span>
<span class="cm">/**</span>
<span class="cm"> * register_chrdev_region() - register a range of device numbers</span>
<span class="cm"> * @from: the first in the desired range of device numbers; must include</span>
<span class="cm"> *        the major number.</span>
<span class="cm"> * @count: the number of consecutive device numbers required</span>
<span class="cm"> * @name: the name of the device or driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value is zero on success, a negative error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">register_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="o">*</span><span class="n">cd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">to</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MKDEV</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">to</span><span class="p">)</span>
<span class="w">            </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">;</span>
<span class="w">        </span><span class="n">cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__register_chrdev_region</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">MINOR</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 略</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">}</span>
</code></pre></div>
<p>如果 <code>count</code> 大於 2<sup>MINORBITS</sup>，會使得 major number 增加，所以之後的 <code>for</code> 迴圈就會針對每個 major number 進行註冊 (因為 <code>__register_chrdev_region()</code> 只能註冊相同 major number 的設備號範圍)。</p>
<p>但大多數情況下不會用到那麼多設備號，就只會執行一次 <code>__register_chrdev_region()</code>，註冊的 major number 就是傳入的 <code>dev_t from</code> 中的 major number，minor number 就是 <code>count</code> (因為此時 <code>next - n == count</code>)。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fs.h&gt;</span>
<span class="cm">/**</span>
<span class="cm"> * alloc_chrdev_region() - register a range of char device numbers</span>
<span class="cm"> * @dev: output parameter for first assigned number</span>
<span class="cm"> * @baseminor: first of the requested range of minor numbers</span>
<span class="cm"> * @count: the number of minor numbers required</span>
<span class="cm"> * @name: the name of the associated device or driver</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a range of char device numbers.  The major number will be</span>
<span class="cm"> * chosen dynamically, and returned (along with the first minor number)</span>
<span class="cm"> * in @dev.  Returns zero or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">alloc_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">baseminor</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="o">*</span><span class="n">cd</span><span class="p">;</span>
<span class="w">    </span><span class="n">cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__register_chrdev_region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">baseminor</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MKDEV</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">baseminor</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>register_chrdev_region()</code> 和 <code>alloc_chrdev_region()</code> 都呼叫 <code>__register_chrdev_region()</code>。</p>
<p><code>__register_chrdev_region()</code> 會往系統的 character device number 資料庫 <code>chrdevs</code> 中插入新的 <code>struct char_device_struct</code>，每個 <code>struct char_device_struct</code> 代表一個 "相同 major number 的設備號範圍"。</p>
<p>先建立一個新的 <code>struct char_device_struct</code>，然後填入設備號範圍。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="cm">/*</span>
<span class="cm"> * Register a single major with a specified minor range.</span>
<span class="cm"> *</span>
<span class="cm"> * If major == 0 this function will dynamically allocate an unused major.</span>
<span class="cm"> * If major &gt; 0 this function will attempt to reserve the range of minors</span>
<span class="cm"> * with given major.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="o">*</span>
<span class="n">__register_chrdev_region</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">baseminor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minorct</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="w"> </span><span class="o">*</span><span class="n">cd</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">char_device_struct</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">major</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_dynamic_major</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// 略</span>
<span class="w">        </span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="c1">// 下面這 4 行本來應該在後面，但我調整順序以方便說明</span>
<span class="w">    </span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">baseminor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseminor</span><span class="p">;</span>
<span class="w">    </span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">minorct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minorct</span><span class="p">;</span>
<span class="w">    </span><span class="n">strlcpy</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// 接下方</span>
</code></pre></div>
<p><code>chrdevs</code> 是一個 hash table，<code>chrdevs</code> 的每個 bucket 以 linked list 儲存多個 entry (<code>struct char_device_struct</code>)。</p>
<p>下面這段程式碼會找出新的 <code>struct char_device_struct</code> 要插入 list 的位置。</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">// 接上方</span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major_to_index</span><span class="p">(</span><span class="n">major</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chrdevs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="n">curr</span><span class="p">;</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">major</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">major</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">baseminor</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">minorct</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">baseminor</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">baseminor</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">baseminor</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">minorct</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 接下方</span>
</code></pre></div>
<p>然後把新的 <code>struct char_device_struct</code> 插入 list 中。</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="c1">// 接上方</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// 插在 list head</span>
<span class="w">        </span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="p">;</span>
<span class="w">        </span><span class="n">chrdevs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">        </span><span class="c1">// 插在 `prev` 和 `curr` 之間 (`prev-&gt;next == curr`)</span>
<span class="w">        </span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cd</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">}</span>
</code></pre></div>
<p>注意：一個 device driver 只有一個 <code>struct cdev</code>，但 (當設備號太多時) 可以有多個 <code>struct char_device_struct</code>。</p>
<p>註冊完成後就可以在 <code>/proc/devices</code> 看到該 device number。</p>
<h4 id="_6">註冊裝置</h4>
<p>TBD</p>
<h4 id="character-device_2">註冊 character device</h4>
<p>先建立一個空的 <code>struct cdev</code>，然後把 device driver 的 <code>struct file_operations</code> 放進去。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/cdev.h&gt;</span>
<span class="cm">/**</span>
<span class="cm">* cdev_init() - initialize a cdev structure</span>
<span class="cm">* @cdev: the structure to initialize</span>
<span class="cm">* @fops: the file_operations for this device</span>
<span class="cm">*</span>
<span class="cm">* Initializes @cdev, remembering @fops, making it ready to add to the</span>
<span class="cm">* system with cdev_add().</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">cdev_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">cdev</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="o">*</span><span class="n">cdev</span><span class="p">);</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="w">    </span><span class="n">kobject_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ktype_cdev_default</span><span class="p">);</span>
<span class="w">    </span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fops</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然後把剛剛建立的 <code>struct cdev</code> 放進 system character device table <code>cdev_map</code> 中。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/cdev.h&gt;</span>
<span class="cm">/**</span>
<span class="cm">* cdev_add() - add a char device to the system</span>
<span class="cm">* @p: the cdev structure for the device</span>
<span class="cm">* @dev: the first device number for which this device is responsible</span>
<span class="cm">* @count: the number of consecutive minor numbers corresponding to this</span>
<span class="cm">*         device</span>
<span class="cm">*</span>
<span class="cm">* cdev_add() adds the device represented by @p to the system, making it</span>
<span class="cm">* live immediately.  A negative error code is returned on failure.</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">cdev_add</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobj_map</span><span class="p">(</span><span class="n">cdev_map</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">exact_match</span><span class="p">,</span><span class="w"> </span><span class="n">exact_lock</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">}</span>
</code></pre></div>
<p>再貼一次 <code>cdev_map</code> 的 data structure。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/char_dev.c</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_map</span><span class="w"> </span><span class="o">*</span><span class="n">cdev_map</span><span class="p">;</span>

<span class="c1">// Linux kernel 5.18.6 /drivers/base/map.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kobj_map</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">              </span><span class="c1">// 第一個 major number 和 minor number，相當於 `struct char_device_struct` 的 `(major, baseminor)`</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">range</span><span class="p">;</span><span class="w">    </span><span class="c1">// 總共幾個 minor number，相當於 `struct char_device_struct` 的 `minorct`</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">        </span><span class="n">kobj_probe_t</span><span class="w"> </span><span class="o">*</span><span class="n">get</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)(</span><span class="kt">dev_t</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w">    </span><span class="c1">// 這裡會指向 `struct cdev`!</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">probes</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>跟 <code>chrdevs</code> 一樣，<code>cdev_map</code> 也使用了 hash table，但真正的 hash table 是 <code>cdev_map-&gt;probes</code>。</p>
<p><code>cdev_map-&gt;probes</code> 的每個 bucket 以 linked list 儲存多個 entry (<code>struct probe</code>)。</p>
<p>因為每個 <code>struct probe</code> 只能儲存相同 major number 的設備號範圍，所以如果設備號太多，就要往 <code>cdev_map-&gt;probes</code> 相對應的 bucket 中加入多個 <code>struct probe</code>，每個 <code>struct probe</code> 對應一個 major number (就是下方程式碼中的 <code>n</code>)。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /drivers/base/map.c</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">kobj_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_map</span><span class="w"> </span><span class="o">*</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">range</span><span class="p">,</span>
<span class="w">         </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="n">kobj_probe_t</span><span class="w"> </span><span class="o">*</span><span class="n">probe</span><span class="p">,</span>
<span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)(</span><span class="kt">dev_t</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_array</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="p">;</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe</span><span class="p">;</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">        </span><span class="c1">// 第一個 major number 和 minor number </span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">;</span><span class="w">    </span><span class="c1">// 總共幾個 minor number</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">      </span><span class="c1">// 指向傳入 `cdev_add` 的 `struct cdev`</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="c1">// 這個 `for` 把 `struct probe` 插入 linked list</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">probe</span><span class="w"> </span><span class="o">**</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">probes</span><span class="p">[</span><span class="n">index</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">255</span><span class="p">];</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">range</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">range</span><span class="p">)</span>
<span class="w">            </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="block-device">Block device</h2>
<h3 id="_7">資料結構</h3>
<p>每個 block device 由一個 <code>struct gendisk</code> 表示。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/blkdev.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    * major/first_minor/minors should not be set by any new driver, the</span>
<span class="cm">    * block core will take care of allocating them automatically.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first_minor</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minors</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">disk_name</span><span class="p">[</span><span class="n">DISK_NAME_LEN</span><span class="p">];</span><span class="w">  </span><span class="cm">/* name of major driver */</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">xarray</span><span class="w"> </span><span class="n">part_tbl</span><span class="p">;</span><span class="w">                        </span><span class="c1">// partition 列表，包含 partition 0 和所有 partition</span>
<span class="w">                                                   </span><span class="c1">// 每個 entry 為 `struct block_device` 型別</span>
<span class="w">                                                   </span><span class="c1">// XArray (Linux kernel 使用的資料結構，功能上等於一般的 array)</span>
<span class="w">                                                   </span><span class="c1">// entry 型別由 "有存取 `part_tbl` 的函式" 所宣告的暫存變數得知</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">part0</span><span class="p">;</span><span class="w">                    </span><span class="c1">// partition 0，代表 "整個 block device"</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">;</span><span class="w">    </span><span class="c1">// 指向負責進行真正的裝置操作的函數</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">};</span>
</code></pre></div>
<p>與 character device 不同，由於可以對 block device 進行分區，也需要有資料結構來表示每個分區。</p>
<p>每個 block device 的分區由一個 <code>struct block_device</code> 表示。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/blk_types.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w">        </span><span class="n">bd_start_sect</span><span class="p">;</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w">        </span><span class="n">bd_nr_sectors</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">           </span><span class="n">bd_dev</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="w">      </span><span class="n">bd_inode</span><span class="p">;</span><span class="w">   </span><span class="cm">/* will die */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="w">    </span><span class="n">bd_super</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">u8</span><span class="w">          </span><span class="n">bd_partno</span><span class="p">;</span><span class="w">          </span><span class="c1">// 此 partition 的編號，0 代表 "整個 block device"，大於 0 代表 "block device 的分區"</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="w">    </span><span class="n">bd_disk</span><span class="p">;</span><span class="w">    </span><span class="c1">// 指向擁有這個分區的 block device 的 `struct gendisk`</span>
<span class="w">    </span><span class="c1">// 略</span>
</code></pre></div>
<p>從抽象觀點來看，"整個 block device" 和 "block device 的分區" 並沒有什麼不同，都是一塊可以儲存 bit 的空間。所以可以將 "整個 block device" 也視為一個 partition，其編號為 0；"block device 的分區" 視為 partition 1 ~ N。</p>
<p>總結來說，一個 block device 會有 (1 + 分割區數目) 個 <code>struct block_device</code>，"整個 block device" 一個，"block device 的分區" 各有一個。</p>
<ul>
<li>每個 block device 有且只有一個 <code>struct gendisk</code><ul>
<li>partition 0 代表整個裝置<ul>
<li>由 <code>struct gendisk</code> 的 member <code>struct block_device *part0</code> 代表該 partition (其實就是整個裝置) 的資訊</li>
<li><code>struct block_device *part0</code> 的 member <code>struct gendisk * bd_disk</code> 指向 block device 的 <code>struct gendisk</code></li>
<li><code>struct block_device *part0</code> 的 member <code>u8 bd_partno</code> 為 <code>0</code></li>
<li><code>struct block_device *part0</code> 的 member <code>dev_t bd_dev</code> 儲存了該 partition (其實就是整個裝置) 的 major number 和 minor number</li>
</ul>
</li>
<li>partition 1 ~ N 代表該裝置上的分割區<ul>
<li>由 <code>struct gendisk</code> 的 member <code>struct xarray part_tbl</code> 儲存所有分區的 <code>struct block_device</code></li>
<li>每個 partition 各有一個 <code>struct block_device</code> 代表該 partition 的資訊</li>
<li><code>struct block_device</code> 的 member <code>struct gendisk * bd_disk</code> 指向 block device 的 <code>struct gendisk</code></li>
<li><code>struct block_device</code> 的 member <code>u8 bd_partno</code> 為 N</li>
<li><code>struct block_device</code> 的 member <code>dev_t bd_dev</code> 儲存了該 partition 的 major number 和 minor number</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>當我們想直接存取 "整個 block device" (如：分割硬碟) 時，只要透過 partition 0 即可。</p>
<h3 id="driver_1">註冊 driver</h3>
<p>當 driver 載入 kernel (無論是 built-in 還是 loadable) 後，需要進行初始化，除了設定 driver 內部使用的資料以外，還需要向 kernel 註冊該 driver 以供使用者使用。</p>
<p>註冊 block device driver 只需要 major number 和 driver 的名字。</p>
<p>註：跟前面說明的 character device driver 不同，註冊 block device driver 時，就只能一次註冊全部的 minor number，不能註冊一部分 minor number。</p>
<p>Kernel 維持著一個 global block device driver table <code>major_names</code>。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /block/genhd.c</span>
<span class="cp">#define BLKDEV_MAJOR_HASH_SIZE 255</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_major_name</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_major_name</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_BLOCK_LEGACY_AUTOLOAD</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">devt</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">major_names</span><span class="p">[</span><span class="n">BLKDEV_MAJOR_HASH_SIZE</span><span class="p">];</span>
</code></pre></div>
<p>以下分析的 <code>register_blkdev()</code> 函式會向 <code>major_names</code> 註冊 driver 所使用的 major number 和 driver 的名字。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/blkdev.h</span>
<span class="cp">#define register_blkdev(major, name) \</span>
<span class="cp">    __register_blkdev(major, name, NULL)</span>
</code></pre></div>
<p><div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /block/genhd.c</span>
<span class="cm">/**</span>
<span class="cm"> * __register_blkdev - register a new block device</span>
<span class="cm"> *</span>
<span class="cm"> * @major: the requested major device number [1..BLKDEV_MAJOR_MAX-1]. If</span>
<span class="cm"> *         @major = 0, try to allocate any unused major number.</span>
<span class="cm"> * @name: the name of the new block device as a zero terminated string</span>
<span class="cm"> * @probe: pre-devtmpfs / pre-udev callback used to create disks when their</span>
<span class="cm"> *     pre-created device node is accessed. When a probe call uses</span>
<span class="cm"> *     add_disk() and it fails the driver must cleanup resources. This</span>
<span class="cm"> *     interface may soon be removed.</span>
<span class="cm"> *</span>
<span class="cm"> * The @name must be unique within the system.</span>
<span class="cm"> *</span>
<span class="cm"> * The return value depends on the @major input parameter:</span>
<span class="cm"> *</span>
<span class="cm"> *  - if a major device number was requested in range [1..BLKDEV_MAJOR_MAX-1]</span>
<span class="cm"> *    then the function returns zero on success, or a negative error code</span>
<span class="cm"> *  - if any unused major number was requested with @major = 0 parameter</span>
<span class="cm"> *    then the return value is the allocated major number in range</span>
<span class="cm"> *    [1..BLKDEV_MAJOR_MAX-1] or a negative error code otherwise</span>
<span class="cm"> *</span>
<span class="cm"> * See Documentation/admin-guide/devices.txt for the list of allocated</span>
<span class="cm"> * major numbers.</span>
<span class="cm"> *</span>
<span class="cm"> * Use register_blkdev instead for any new code.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">__register_blkdev</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">devt</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_major_name</span><span class="w"> </span><span class="o">**</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="cm">/* temporary */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">major</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">major_names</span><span class="p">)</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">major_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// 略</span>
<span class="w">        </span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_major_name</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLOCK_LEGACY_AUTOLOAD</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">probe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">strlcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major_to_index</span><span class="p">(</span><span class="n">major</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">major_names</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"> </span><span class="o">*</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">major</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!*</span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
註冊完成後就可以在 <code>/proc/devices</code> 看到該 device number。</p>
<p>除了註冊和取消註冊相關的函式，唯一會存取 <code>major_names</code> 的函式只有 <code>blkdev_show()</code>。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /block/genhd.c</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">blkdev_show</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="n">seqf</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_major_name</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">;</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">major_names_spinlock</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major_names</span><span class="p">[</span><span class="n">major_to_index</span><span class="p">(</span><span class="n">offset</span><span class="p">)];</span><span class="w"> </span><span class="n">dp</span><span class="p">;</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="w">            </span><span class="n">seq_printf</span><span class="p">(</span><span class="n">seqf</span><span class="p">,</span><span class="w"> </span><span class="s">"%3d %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">major_names_spinlock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span>
</code></pre></div>
<p>而唯一會呼叫 <code>blkdev_show()</code> 的函式只有 <code>devinfo_show()</code>。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /fs/proc/devices.c</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">devinfo_show</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CHRDEV_MAJOR_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">seq_puts</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">"Character devices:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="n">chrdev_show</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">CHRDEV_MAJOR_MAX</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">seq_puts</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">Block devices:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="n">blkdev_show</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>與 <code>/proc/devices</code> 的內容相同！</p>
<p><strong>注意</strong>: 這裡只是向 kernel 註冊了 device driver，還沒有註冊任何真正的 device！</p>
<h3 id="block-device_1">註冊裝置和註冊 block device</h3>
<p>所有的裝置不是在開機前就接上去，就是在開機後才接上去 (熱插拔, hot swapping/hot plugging)。無論是哪種，在 driver 載入並初始化 (包含上一節的註冊 driver) 完成後的某個時間點，kernel 會通知 driver 處理新的裝置，driver 會將新的裝置設定好，並向 kernel 註冊該裝置以供使用者使用。</p>
<p>每個 driver 只需要註冊一次 driver (上一節的內容)，但每個使用該 driver 的裝置都需要進行註冊 (這一節的內容)。</p>
<p>TBD</p>
<p>先建立一個空的 <code>struct gendisk</code>。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /include/linux/blkdev.h</span>
<span class="cm">/**</span>
<span class="cm"> * blk_alloc_disk - allocate a gendisk structure</span>
<span class="cm"> * @node_id: numa node to allocate on</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate and pre-initialize a gendisk structure for use with BIO based</span>
<span class="cm"> * drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * Context: can sleep</span>
<span class="cm"> */</span>
<span class="cp">#define blk_alloc_disk(node_id)                     \</span>
<span class="cp">({                                  \</span>
<span class="cp">    </span><span class="c1">// 略 \</span>
<span class="w">    </span><span class="n">__blk_alloc_disk</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">__key</span><span class="p">);</span><span class="w">              </span>\
<span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /block/genhd.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">__blk_alloc_disk</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="o">*</span><span class="n">lkclass</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__alloc_disk_node</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">lkclass</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">disk</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6 /block/genhd.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">__alloc_disk_node</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="o">*</span><span class="n">lkclass</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc_node</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">node_id</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bdev_alloc</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">                             </span><span class="c1">// 為 "整個 block device" 建立一個 `struct block_device`</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">xa_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part_tbl</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xa_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part_tbl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">))</span><span class="w">    </span><span class="c1">// 把 partition 0 ("整個 block device") 放入 partition 列表</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_destroy_part_tbl</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">rand_initialize_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">block_class</span><span class="p">;</span>
<span class="w">    </span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disk_type</span><span class="p">;</span>
<span class="w">    </span><span class="n">device_initialize</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">disk</span><span class="p">));</span>
<span class="w">    </span><span class="n">inc_diskseq</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disk</span><span class="p">;</span>
<span class="w">    </span><span class="n">lockdep_init_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">lockdep_map</span><span class="p">,</span><span class="w"> </span><span class="s">"(bio completion)"</span><span class="p">,</span><span class="w"> </span><span class="n">lkclass</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BLOCK_HOLDER_DEPRECATED</span>
<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">slave_bdevs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">disk</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="p">}</span>
</code></pre></div>
<p>向剛剛建立的 <code>struct gendisk</code> 填入 <code>major</code>, <code>first_minor</code>, <code>minors</code>, <code>disk_name</code>, <code>fops</code> 等資訊。</p>
<p>然後把剛剛建立的 <code>struct gendisk</code> 放進 system block device table ?TBD 中。</p>
<p>TBD: <code>add_disk()</code> 同時完成 "註冊裝置" 和 "註冊 block device" 兩件事。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6  /include/linux/blkdev.h</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__must_check</span><span class="w"> </span><span class="nf">add_disk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">device_add_disk</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux kernel 5.18.6  /block/genhd.c</span>
<span class="cm">/**</span>
<span class="cm"> * device_add_disk - add disk information to kernel list</span>
<span class="cm"> * @parent: parent device for the disk</span>
<span class="cm"> * @disk: per-device partitioning information</span>
<span class="cm"> * @groups: Additional per-device sysfs groups</span>
<span class="cm"> *</span>
<span class="cm"> * This function registers the partitioning information in @disk</span>
<span class="cm"> * with the kernel.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="n">__must_check</span><span class="w"> </span><span class="nf">device_add_disk</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">groups</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">ddev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If the driver provides an explicit major number it also must provide</span>
<span class="cm">     * the number of minors numbers supported, and those will be used to</span>
<span class="cm">     * setup the gendisk.</span>
<span class="cm">     * Otherwise just allocate the device numbers for both the whole device</span>
<span class="cm">     * and all partitions from the extended dev_t space.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">DISK_MAX_PARTS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pr_err</span><span class="p">(</span><span class="s">"block: can't allocate more than %d partitions</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="w">                </span><span class="n">DISK_MAX_PARTS</span><span class="p">);</span>
<span class="w">            </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DISK_MAX_PARTS</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MINORMASK</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_alloc_ext_minor</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">        </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_EXT_MAJOR</span><span class="p">;</span>
<span class="w">        </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">;</span>
<span class="w">    </span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="p">;</span>
<span class="w">    </span><span class="n">dev_set_name</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span><span class="w"> </span><span class="s">"%s"</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">GENHD_FL_HIDDEN</span><span class="p">))</span>
<span class="w">        </span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MKDEV</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_add</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span><span class="w">    </span><span class="c1">// 註冊裝置</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disk_alloc_events</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sysfs_deprecated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysfs_create_link</span><span class="p">(</span><span class="n">block_depr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">kobject_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// 略</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_integrity_add</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="o">-&gt;</span><span class="n">bd_holder_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">"holders"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">slave_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">"slaves"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bd_register_pending_holders</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_register_queue</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 略</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">GENHD_FL_HIDDEN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bdi_register</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">,</span><span class="w"> </span><span class="s">"%u:%u"</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 略</span>
<span class="w">        </span><span class="n">bdi_set_owner</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="p">,</span><span class="w"> </span><span class="n">ddev</span><span class="p">);</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">bdi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="s">"bdi"</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 略</span>
<span class="w">        </span><span class="n">bdev_add</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span><span class="w"> </span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">))</span>
<span class="w">            </span><span class="n">disk_scan_partitions</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">FMODE_READ</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Announce the disk and partitions after all partitions are</span>
<span class="cm">         * created. (for hidden disks uevents remain suppressed forever)</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">dev_set_uevent_suppress</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">disk_uevent</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">KOBJ_ADD</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">disk_update_readahead</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="n">disk_add_events</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="n">set_bit</span><span class="p">(</span><span class="n">GD_ADDED</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 略</span>
</code></pre></div>
<h2 id="device-file">存取 device file</h2>
<p><a href="https://www.tiehichi.site/2020/03/13/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B/">字符设备访问流程 - Tiehichi's Blog</a></p>
<p><a href="Linux kernel - virtual file system (VFS).md">Linux kernel: virtual file system (VFS)</a></p>
<p>即便指定的設備號尚未被註冊，<code>mknod</code> 指令依舊可以建立 device file，但存取時會出現 "Permission denied"。</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c2be25ad.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>